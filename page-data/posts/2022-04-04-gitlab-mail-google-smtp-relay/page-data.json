{"componentChunkName":"component---src-templates-post-js","path":"/posts/2022-04-04-gitlab-mail-google-smtp-relay/","result":{"data":{"site":{"siteMetadata":{"title":"MJUN Tech Note","author":"Junya Morioka"}},"markdownRemark":{"id":"b74adee4-c78c-52c3-b47a-641af4b250d3","html":"<p>私はクレデンシャルなソースコードを管理するために，自宅サーバでGitLabをセルフホストしています．<br>\n基本的にユーザーは自分しかいないのですが，メール通知があったほうが便利かと思い，メールを設定することにしました．</p>\n<p>ちょうど，このサイトのドメインを使ってGoogle Workspaceを契約しているので，提供されているSMTPリレーサービスを使って，\nGoogle経由でメール通知を行うことにします．</p>\n<h2 id=\"op25b問題について\">OP25B問題について</h2>\n<p>自宅サーバーでメールの送信を行うのに問題になるのが「OP25B」です．</p>\n<p><a href=\"https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html\">https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html</a></p>\n<p>これは迷惑メール対策のために，プロバイダーが自宅からのメール送信をブロックしてしまう問題です．<br>\nこれを回避するためにプロバイダが用意しているSMTPリレーサーバを中継してメールを送信するのですが，\nそもそもSMTPサーバが提供されていなかったり，制限があることがあります．<br>\nそこで，今回は独自ドメイン内なら制限の緩い，Google WorkspaceのSMTPリレーサービスを使うことにします．</p>\n<h2 id=\"google-workspaceの設定\">Google Workspaceの設定</h2>\n<p>まずは，Google Workspaceの管理コンソールへ行きます．</p>\n<p><a href=\"https://support.google.com/a/answer/2956491?hl=ja\">https://support.google.com/a/answer/2956491?hl=ja</a></p>\n<p>上記のサイトに書かれているように，\n管理コンソールから、アプリ->Google Workspace->Gmail->ルーティングと進み，SMTPリレーサービスの設定画面を開きます．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/171fdd08be73f0906ca6c8017eec88b9/0d98f/2022-04-04-gitlab.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAABtUlEQVR42qVTWy4EQRTtpbADWyD4YAX49kckXstBsAXBWAATfxJBzPCjM62fM1X9mq7qOnLvZCYyD6Pp5KRuV/c9de69p6ylnTus7NaxslfH6l4d81u3jIXtuz/Bmtt8xuJBA4v7DSwfNjCz9ojZjUfMrlfERg/W6bWLowsHJ1cuji8/Qe9nNQ/nN34lnNY8hgUUgBIAuj2YBIDBXx5jAMsPIrw23pDlBZQ2KAqNQpVQVaBLziFYWmt0u92hkwzKsmRQXAUWEVBilmVI0xRxHOM/DxMSWavVgm3baDabTEzI83ygmDApHlFIASUnSYJOp8MqoyiCEGJsIlXU3x+rkIgc57PiRM3kkkutkSYCsZRcPg2JFFNMh9FKasMwHNuGEUJdlni3BT4+bO6j67oMz/O4dCKl1fd9Jp+ikHoC3L9k6IgYYRBwIhFIKccmTiL7NuUUInJ6Vv+hZ8MTnkhYKI2ndwEhY8Sx5F7RtPuTVkpNVTZS8sNbCikTLjMIArTb7cH6nfAnD7IPe99NJZtM7SGbdcodHVZI5iblBNpLc7r7g5vS//n3hiYishPdKiJ3wgKFMvgCMUSO9Ze4vZ8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"smtp\"\n        title=\"\"\n        src=\"/static/171fdd08be73f0906ca6c8017eec88b9/5a190/2022-04-04-gitlab.png\"\n        srcset=\"/static/171fdd08be73f0906ca6c8017eec88b9/772e8/2022-04-04-gitlab.png 200w,\n/static/171fdd08be73f0906ca6c8017eec88b9/e17e5/2022-04-04-gitlab.png 400w,\n/static/171fdd08be73f0906ca6c8017eec88b9/5a190/2022-04-04-gitlab.png 800w,\n/static/171fdd08be73f0906ca6c8017eec88b9/c1b63/2022-04-04-gitlab.png 1200w,\n/static/171fdd08be73f0906ca6c8017eec88b9/0d98f/2022-04-04-gitlab.png 1276w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>上記のように，</p>\n<ul>\n<li>ドメイン内のアドレスのみ</li>\n<li>SMTP認証を必須とする</li>\n<li>TLSによる暗号化を有効にする</li>\n</ul>\n<p>を設定します．</p>\n<p>次に，Googleアカウントに2段階認証を設定している場合は，\nアカウント設定で，アプリパスワードを発行します．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/45fa3ae80c85e142272849d270a3d6d7/966c1/google_app_password.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABD0lEQVR42n2SzUrEMBCA+8Q+geDJqzfxFTyJoKDePAqLF9/B9rBuaZo0yTYz+STproh0HRgmZCbf/KVxzuF9wFqHMSMhRnLOJ1U1oyJImhFV9rMwJ0UP/qZtW/q+ZxgGjDFM08Sa5IMtwJDAK8Q4AwIksmr1N6uP/1T1W1JKTO0Gtznj4emRy7stN88dg9svwBKgqicBxwQigmZIwRA/rpnez3l5fePidsvV/SdmSguwzLBA1yqrWpqShB0N42gp8VHXh5JEaLqu42u3w1pbwaXAnwXUajMuZro+QpblXsrMls5Ec9V6LsDjQkpmEV2ZXybOys540rxfjVm2fwCGEPDeU+zpr6KEGhNJSf4FfgN1dG+dLsWn/QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"google_app\"\n        title=\"\"\n        src=\"/static/45fa3ae80c85e142272849d270a3d6d7/5a190/google_app_password.png\"\n        srcset=\"/static/45fa3ae80c85e142272849d270a3d6d7/772e8/google_app_password.png 200w,\n/static/45fa3ae80c85e142272849d270a3d6d7/e17e5/google_app_password.png 400w,\n/static/45fa3ae80c85e142272849d270a3d6d7/5a190/google_app_password.png 800w,\n/static/45fa3ae80c85e142272849d270a3d6d7/c1b63/google_app_password.png 1200w,\n/static/45fa3ae80c85e142272849d270a3d6d7/29007/google_app_password.png 1600w,\n/static/45fa3ae80c85e142272849d270a3d6d7/966c1/google_app_password.png 1694w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>このアプリパスワードを使ってSMTP認証を行ってメールを送信します．</p>\n<h2 id=\"gitlab-docker-composeymlの設定\">GitLab docker-compose.ymlの設定</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.7'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">gitlab</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> gitlab/gitlab<span class=\"token punctuation\">-</span>ce<span class=\"token punctuation\">:</span>14.7.2<span class=\"token punctuation\">-</span>ce.0\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'hoge.com'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">GITLAB_OMNIBUS_CONFIG</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        external_url 'http://hoge.com'\n        gitlab_rails['time_zone'] = 'Asia/Tokyo'</span>\n\n        <span class=\"token comment\"># mail</span>\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_enable'</span><span class=\"token punctuation\">]</span> = true\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_address'</span><span class=\"token punctuation\">]</span> = \"smtp<span class=\"token punctuation\">-</span>relay.gmail.com\"\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_port'</span><span class=\"token punctuation\">]</span> = 587\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_domain'</span><span class=\"token punctuation\">]</span> = <span class=\"token punctuation\">[</span>独自ドメイン or gmail.com<span class=\"token punctuation\">]</span>\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_authentication'</span><span class=\"token punctuation\">]</span> = \"login\"\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_user_name'</span><span class=\"token punctuation\">]</span> = <span class=\"token punctuation\">[</span>Googleアカウントのユーザー名<span class=\"token punctuation\">]</span>\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_password'</span><span class=\"token punctuation\">]</span> = <span class=\"token punctuation\">[</span>Googleアカウントのパスワード or アプリパスワード<span class=\"token punctuation\">]</span>\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'gitlab_email_from'</span><span class=\"token punctuation\">]</span> = 'gitlab@gmail.com'\n        gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'gitlab_email_reply_to'</span><span class=\"token punctuation\">]</span> = 'noreply@gmail.com'\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'80:80'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'22:22'</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./gitlab/data<span class=\"token punctuation\">:</span>/var/opt/gitlab\n      <span class=\"token punctuation\">-</span> ./gitlab/logs<span class=\"token punctuation\">:</span>/var/log/gitlab\n      <span class=\"token punctuation\">-</span> ./gitlab/config<span class=\"token punctuation\">:</span>/etc/gitlab</code></pre></div>\n<p>上記のように，docker-compose.yamlを編集して，起動すれば設定は以上です．</p>\n<p>メールの送信ができているかは，GitLabアカウントのメールアドレス認証をやってみると良いです．</p>\n<h3 id=\"参考\">参考</h3>\n<p><a href=\"https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html\">https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html</a></p>\n<p><a href=\"https://support.google.com/a/answer/2956491?hl=ja\">https://support.google.com/a/answer/2956491?hl=ja</a></p>\n<p><a href=\"https://docs.gitlab.com/omnibus/settings/smtp.html\">https://docs.gitlab.com/omnibus/settings/smtp.html</a></p>","tableOfContents":"<ul>\n<li><a href=\"#op25b%E5%95%8F%E9%A1%8C%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">OP25B問題について</a></li>\n<li><a href=\"#google-workspace%E3%81%AE%E8%A8%AD%E5%AE%9A\">Google Workspaceの設定</a></li>\n<li><a href=\"#gitlab-docker-composeyml%E3%81%AE%E8%A8%AD%E5%AE%9A\">GitLab docker-compose.ymlの設定</a></li>\n</ul>","excerpt":"私はクレデンシャルなソースコードを管理するために，自宅サーバでGitLabをセルフホストしています． 基本的にユーザーは自分しかいないのですが，メール通知があったほうが便利かと思い，メールを設定することにしました． ちょうど，このサイトのドメインを使ってGoogle…","frontmatter":{"title":"docker-composeのGitlabのメール通知をGoogle WorkspaceのSMTPリレーで行う","date":"2022.04.04","update":"2022.04.04","category":"Server","tags":["Server","Linux","Ubuntu","GitLab","SMTP"]},"fields":{"slug":"/posts/2022-04-04-gitlab-mail-google-smtp-relay/"}}},"pageContext":{"id":"b74adee4-c78c-52c3-b47a-641af4b250d3"}},"staticQueryHashes":["1123391092"],"slicesMap":{}}