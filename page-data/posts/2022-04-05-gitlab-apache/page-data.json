{"componentChunkName":"component---src-templates-post-js","path":"/posts/2022-04-05-gitlab-apache/","result":{"data":{"site":{"siteMetadata":{"title":"MJUN Tech Note","author":"Junya Morioka"}},"markdownRemark":{"id":"b7ab4f08-f27e-541e-9887-d18edf0ed0c2","html":"<p>今回はUbuntuでApacheを使ってGitlabをサブディレクトリで立てる方法です．<br>\nSSL証明書はGitLabではなく，Apacheとcertbotで管理します．</p>\n<p>今回のゴールは，<code class=\"language-text\">https://hoge.com/gitlab</code>にGitLabを立てることです．</p>\n<h2 id=\"apacheのインストール\">apacheのインストール</h2>\n<p>まずはapache2のインストール．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> apache2\n<span class=\"token function\">sudo</span> systemctl status apache</code></pre></div>\n<h2 id=\"certbotの導入\">certbotの導入</h2>\n<p>次にcertbotを導入します．予め，登録用のメールアドレスとドメインを用意してください．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> certbot python3-certbot-apache\n<span class=\"token function\">sudo</span> certbot <span class=\"token parameter variable\">--apache</span>\n\nEnter email address <span class=\"token punctuation\">(</span>used <span class=\"token keyword\">for</span> urgent renewal and security notices<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Enter <span class=\"token string\">'c'</span> to\ncancel<span class=\"token punctuation\">)</span>: hoge@hoge.com\n\nYou must agree <span class=\"token keyword\">in</span> order to register with the ACME server at\nhttps://acme-v02.api.letsencrypt.org/directory\n<span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span>gree/<span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span>ancel: A\n\nWould you be willing to share your email address with the Electronic Frontier\nFoundation, a founding partner of the Let s Encrypt project and the non-profit\norganization that develops Certbot?\n<span class=\"token punctuation\">(</span>Y<span class=\"token punctuation\">)</span>es/<span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>o: N\n\nWhich names would you like to activate HTTPS for?\n----------------------------------------\n<span class=\"token number\">1</span>: hoge.com\n----------------------------------------\n <span class=\"token punctuation\">(</span>Enter <span class=\"token string\">'c'</span> to cancel<span class=\"token punctuation\">)</span>: <span class=\"token number\">1</span>\n\nPlease choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.\n----------------------------------------\n<span class=\"token number\">1</span>: No redirect\n<span class=\"token number\">2</span>: Redirect\n----------------------------------------\n<span class=\"token punctuation\">(</span>press <span class=\"token string\">'c'</span> to cancel<span class=\"token punctuation\">)</span>: <span class=\"token number\">2</span>\n\nCongratulations<span class=\"token operator\">!</span> You have successfully enabled https://hoge.com\n\n<span class=\"token comment\"># 自動更新が働いているかを確認</span>\n<span class=\"token function\">sudo</span> systemctl status certbot.timer</code></pre></div>\n<h2 id=\"apacheの設定\">apacheの設定</h2>\n<p>次に，apacheにProxyの設定をします．<br>\n<code class=\"language-text\">/etc/apache2/sites-enabled/000-default-le-ssl.conf</code>に以下を加筆します．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ProxyPass /gitlab http://localhost:8000/gitlab\nProxyPassReverse /gitlab http://localhost:8000/gitlab</code></pre></div>\n<p>ついでにapacheのバージョンが外から見えないように，<code class=\"language-text\">/etc/apache2/conf-enabled/security.conf</code>を編集します．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ServerTokens Prod\nServerSignature Off</code></pre></div>\n<p>設定が終わったら，apacheを再起動します．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart apache</code></pre></div>\n<h2 id=\"gitlabの立ち上げ\">GitLabの立ち上げ</h2>\n<p>今回はdocker-composeでGitLabを立ち上げます．</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.7'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">gitlab</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> gitlab/gitlab<span class=\"token punctuation\">-</span>ce<span class=\"token punctuation\">:</span>14.7.7<span class=\"token punctuation\">-</span>ce.0\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'hoge.com'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">GITLAB_OMNIBUS_CONFIG</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        external_url 'http://hoge.com/gitlab/'\n        gitlab_rails['gitlab_shell_ssh_port'] = 22\n        gitlab_rails['time_zone'] = 'Asia/Tokyo'\n        letsencrypt['enable'] = false\n        nginx['listen_port'] = 8088</span>\n\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'8000:8000'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'22:22'</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./gitlab/data<span class=\"token punctuation\">:</span>/var/opt/gitlab\n      <span class=\"token punctuation\">-</span> ./gitlab/logs<span class=\"token punctuation\">:</span>/var/log/gitlab\n      <span class=\"token punctuation\">-</span> ./gitlab/config<span class=\"token punctuation\">:</span>/etc/gitlab</code></pre></div>\n<p>SSL証明書はapacheで管理するので，<code class=\"language-text\">letsencrypt['enable'] = false</code>としておきます．</p>\n<p>以上でapache経由で任意のサブディレクトリでGitLabにアクセスできます．</p>","tableOfContents":"<ul>\n<li><a href=\"#apache%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">apacheのインストール</a></li>\n<li><a href=\"#certbot%E3%81%AE%E5%B0%8E%E5%85%A5\">certbotの導入</a></li>\n<li><a href=\"#apache%E3%81%AE%E8%A8%AD%E5%AE%9A\">apacheの設定</a></li>\n<li><a href=\"#gitlab%E3%81%AE%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92\">GitLabの立ち上げ</a></li>\n</ul>","excerpt":"今回はUbuntuでApacheを使ってGitlabをサブディレクトリで立てる方法です． SSL証明書はGitLabではなく，Apacheとcertbotで管理します． 今回のゴールは，にGitLabを立てることです． apacheのインストール まずはapache…","frontmatter":{"title":"UbuntuでGitLabをapache経由でproxyする","date":"2022.04.05","update":"2022.04.05","category":"Server","tags":["Server","Linux","Ubuntu","GitLab"]},"fields":{"slug":"/posts/2022-04-05-gitlab-apache/"}}},"pageContext":{"id":"b7ab4f08-f27e-541e-9887-d18edf0ed0c2"}},"staticQueryHashes":["1123391092"],"slicesMap":{}}