{"componentChunkName":"component---src-templates-post-js","path":"/posts/2022-09-05_mlflow-onpre/","result":{"data":{"site":{"siteMetadata":{"title":"MJUN Tech Note","author":"Junya Morioka"}},"markdownRemark":{"id":"f59e5530-5502-5001-ac6a-97fcf92c22fa","html":"<p>こんにちは．今回は実験管理ツールであるMLflowをオンプレミスで構築する方法についてご紹介します．</p>\n<h2 id=\"導入の動機\">導入の動機</h2>\n<p>機械学習を扱っていると，ハイパーパラメータやモデル，データセットを変更しながら様々な実験を行うことになります．この際，結果の比較を効率的に行える実験管理ツールを導入することで，実験同士の比較をスムーズに行おうと考えました．</p>\n<p>この手の実験管理ツールは，MLOpsが盛んな今，TensorboardやWeight &#x26; Bias(wandb)など，様々ありますが，最近は<a href=\"https://www.mlflow.org\">MLflow</a>が選択肢として大きく盛り上がっています．</p>\n<p>しかし，様々ある実験管理ツールの中で，データの外部送信を行わずに扱える「オンプレミス」「自前サーバ」という点に着目すると選択肢はさほど多くなく，最も使われているであろうMLflowを構築してみようと思います．</p>\n<h2 id=\"mlflowとは\">MLflowとは</h2>\n<p>Mlflowはオープンソースの機械学習のライフサイクル管理ツールで，\nMLflow Tracking, Projects, Models, Registoryからなるモジュールに分かれています．</p>\n<p>今回は主に実験管理を行うMLflow Tracking Serverをオンプレのサーバに建てる方法をまとめます．<br>\nMLflow Trackingでは機械学習モデルのハイパーパラメータや精度，ログファイルをMLflow側で一括管理することができるので，実験同士の比較を簡単に行うことができます．</p>\n<h2 id=\"構成図\">構成図</h2>\n<p>今回はDocker Composeを用いて，MLflow Tracking Serverを構築していきます．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99bb4229e964d40da3cfe6019f627afd/a88f6/Pasted_image_20220905115005.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABl0lEQVR42o2S3W7TMBiGe7tcAadInHAAuwe0E46YOEAb4wBNQvxV06YKNK2kTSCZsjZJ07hN/BPbz5QMNopU6CdZtvzZj1+9rwfee7ry3tFaj7HQSPDW453DWos1DqO62WOM4f7O7fxnDfpN7+laIh8zC15SxAeMfl5yXQqM1FyVEz5cHPIt+UTdrMDfwv4BdD1wmbyhPHvA/OAho/1nxMGY9VpxHp3w4uMeh6PnLER2p247kK4JWjeouqTOlqh5RqskznlKUZDMI7LlDK31LsB7P7QD6R3SOaRSSClpjaEWAqzdOPsfhZ51VTE7G5J+fs8inNBa28Pi+YLh95ivP64Rq/UOCn+FUqdXRHuPSZ4+YnH0itZDqxVfEsGT4wv2TxMyUW8A/4beKXTesypy0pO3zN4dswoucX1elmkmeH06ZhjOEHWzm4dKSsIoIl8u+1FWgqIoyPOclajwtkXLpg+lbdutPm6E0n1iYzRaqd67LpAOGAQBk+mUMAyJooiqqraqHGxL63d1itI0JY5jkiTp191D24A3AEdPa72yr64AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Pasted image 20220905115005\"\n        title=\"\"\n        src=\"/static/99bb4229e964d40da3cfe6019f627afd/5a190/Pasted_image_20220905115005.png\"\n        srcset=\"/static/99bb4229e964d40da3cfe6019f627afd/772e8/Pasted_image_20220905115005.png 200w,\n/static/99bb4229e964d40da3cfe6019f627afd/e17e5/Pasted_image_20220905115005.png 400w,\n/static/99bb4229e964d40da3cfe6019f627afd/5a190/Pasted_image_20220905115005.png 800w,\n/static/99bb4229e964d40da3cfe6019f627afd/c1b63/Pasted_image_20220905115005.png 1200w,\n/static/99bb4229e964d40da3cfe6019f627afd/29007/Pasted_image_20220905115005.png 1600w,\n/static/99bb4229e964d40da3cfe6019f627afd/a88f6/Pasted_image_20220905115005.png 1900w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p><a href=\"https://mlflow.org/docs/latest/tracking.html#scenario-5-mlflow-tracking-server-enabled-with-proxied-artifact-storage-access\">https://mlflow.org/docs/latest/tracking.html#scenario-5-mlflow-tracking-server-enabled-with-proxied-artifact-storage-access</a> より引用</p>\n</blockquote>\n<p>MLflowでは，実験の結果等の数値だけでなく，configファイルやソースコード，学習済みモデルファイル等のバイナリファイルもStoreすることができます．この際，バイナリファイルはartifactと呼ばれ，数値とは別の場所に保存されます．</p>\n<p>今回は<a href=\"https://mlflow.org/docs/latest/tracking.html#scenario-5-mlflow-tracking-server-enabled-with-proxied-artifact-storage-access\">MLflowのドキュメント</a>にもあるように，実験のパラメータ等をMySQLのDBに保存し，artifactをDockerで立てたAWS S3互換のオブジェクトファイルストレージであるMinIOに保存していきます．</p>\n<p>また，MLflowにユーザー認証をかけるためにDockerのnginx-proxyを用いて，Basic認証を導入します．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8546a7d816f9e40cfbed7929d71bf323/78363/Pasted_image_20220905121716.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVR42nWS208aQRjF+ev7UowpeAEkTR96eetDG6napDVWFpYFYjV4WQLB1SJycbkJC+x8v2bYtbW1neTMyUwyX86ZcyKES2S5M1ewX5vx/vieD5Up27aQsSHzH9624eOFsFeDgQcREUFDLScKdg+eH3hEvw6J7o+I5YW4CXFT/gJLrJuKZAlWsgrDESKBOj0wUFppw3oB0mXYKkOqqCFLToasz5uW8Mqa0Oz0qdYbXLZHFJxZoFCvha9AFpy0FPF88HCzoEgUCWAJyfBOc9yYkcwOsOw2uYpDrupiOgsio9GIyWSC67rc9Tp8r91yduVyWm9SbfZJmnPelcecN1qc1m84qvdIWYo1Y7pUGS/AZgmiWThoQGQ8HqMx9TzEn2PfjDn7MeSsccv5tcuGMeFtaUSt2efC6XJyNWQj5xE7vCdpKd4cLXhd9nhZnHPYUES0Ot/3H8LmtAMv8qG90GZiaVVIWLBRUKRK2vKcdFa76nLdqNLq3FHUf/gwSKkg5UpbWCvAVkkeBSJ/hKNZ/2namvG54rJ33CZzMsC49B/XJuih3RVWc/KPmjytTcyElRysmvDsGxgOvxWGYTP3IesEhd2pwqcnkF/YqQq7IX+pC0NP+Al2pcrSMmkrBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Pasted image 20220905121716\"\n        title=\"\"\n        src=\"/static/8546a7d816f9e40cfbed7929d71bf323/5a190/Pasted_image_20220905121716.png\"\n        srcset=\"/static/8546a7d816f9e40cfbed7929d71bf323/772e8/Pasted_image_20220905121716.png 200w,\n/static/8546a7d816f9e40cfbed7929d71bf323/e17e5/Pasted_image_20220905121716.png 400w,\n/static/8546a7d816f9e40cfbed7929d71bf323/5a190/Pasted_image_20220905121716.png 800w,\n/static/8546a7d816f9e40cfbed7929d71bf323/c1b63/Pasted_image_20220905121716.png 1200w,\n/static/8546a7d816f9e40cfbed7929d71bf323/78363/Pasted_image_20220905121716.png 1522w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"docker-compose\">Docker Compose</h2>\n<p>というわけで，Docker Composeで以下のコンテナを立てて構築していきます</p>\n<ul>\n<li>Nginx Proxy(jwilder/nginx-proxy)</li>\n<li>MLflow Tracking Server</li>\n<li>MySQL 8.0</li>\n<li>MinIO</li>\n</ul>\n<p>実際に動かせるものは，こちらのGithubにあります．</p>\n<p><a href=\"https://github.com/mjun0812/MLflow-Docker\">https://github.com/mjun0812/MLflow-Docker</a></p>\n<p>まず，MLflow Tracking ServerのDockerfileは以下です．</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.10</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> pip install -U pip &amp;&amp; <span class=\"token operator\">\\</span>\n    pip install --no-cache-dir mlflow mysqlclient boto3</span></code></pre></div>\n<p>全体の<code class=\"language-text\">docker-compose.yml</code>は以下です．下記の例ではmlflowを5000番ポートでListenさせています．</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># MLflow</span>\n  <span class=\"token key atrule\">mlflow</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mlflow\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">80</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n      <span class=\"token punctuation\">-</span> minio\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Tokyo\n      <span class=\"token key atrule\">VIRTUAL_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"example.com,localhost\"</span>\n      <span class=\"token key atrule\">MLFLOW_S3_ENDPOINT_URL</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//minio<span class=\"token punctuation\">:</span><span class=\"token number\">9000</span>\n      <span class=\"token key atrule\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">:</span> minio\n      <span class=\"token key atrule\">AWS_SECRET_ACCESS_KEY</span><span class=\"token punctuation\">:</span> minio\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      mlflow server \n      --backend-store-uri 'mysql+mysqldb://mlflow:mlflow@db:3306/mlflow'\n      --artifacts-destination 's3://mlflow/artifacts' \n      --serve-artifacts --host 0.0.0.0 --port 80</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span>8.0.29\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Tokyo\n    <span class=\"token key atrule\">cap_add</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># https://github.com/docker-library/mysql/issues/422</span>\n      <span class=\"token punctuation\">-</span> SYS_NICE\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./mysql/data<span class=\"token punctuation\">:</span>/var/lib/mysql\n      <span class=\"token punctuation\">-</span> ./mysql/my.cnf<span class=\"token punctuation\">:</span>/etc/mysql/conf.d/my.cnf\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token comment\"># S3互換のストレージ</span>\n  <span class=\"token key atrule\">minio</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> minio/minio\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./minio<span class=\"token punctuation\">:</span>/export\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MINIO_ACCESS_KEY</span><span class=\"token punctuation\">:</span> minio\n      <span class=\"token key atrule\">MINIO_SECRET_KEY</span><span class=\"token punctuation\">:</span> minio\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> server /export\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token comment\"># minioコンテナ起動時にデフォルトのバケットを自動作成する</span>\n  <span class=\"token key atrule\">defaultbucket</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> minio/mc\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> minio\n    <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      /bin/sh -c \"\n      until (/usr/bin/mc config host add minio http://minio:9000 minio minio) do echo 'try to create buckets...' &amp;&amp; sleep 1; done;\n      /usr/bin/mc mb minio/mlflow;\n      /usr/bin/mc policy download minio/mlflow;\n      exit 0;\n      \"</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token key atrule\">nginx-proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"5000:80\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./nginx/htpasswd<span class=\"token punctuation\">:</span>/etc/nginx/htpasswd\n      <span class=\"token punctuation\">-</span> ./nginx/certs/<span class=\"token punctuation\">:</span>/etc/nginx/certs\n      <span class=\"token punctuation\">-</span> ./nginx/conf.d/proxy.conf<span class=\"token punctuation\">:</span>/etc/nginx/conf.d/proxy.conf\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mlflow-net</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</code></pre></div>\n<p>以下，<code class=\"language-text\">docker-compose.yml</code>を順に見ていきます．</p>\n<h3 id=\"mlflow\">MLflow</h3>\n<p>下記では，MLflow Tracking Serverを立てています．<br>\n今回は同じコンテナネットワークにあるMinIOをartifactのストレージとするため，\n<code class=\"language-text\">AWS_ACCESS_KEY_ID</code>と<code class=\"language-text\">AWS_SECRET_ACCESS_KEY</code>を設定しておきます．</p>\n<p>また，ssh port forward等でMLflowのUIにアクセスすることも考えて，<code class=\"language-text\">VIRTUAL_HOST</code>には\nサーバーのホスト名だけでなく，<code class=\"language-text\">localhost</code>も追加しておきます．ポートはnginx-proxyの都合上，\n80番でListenさせておきます．</p>\n<p>mlflowのコマンドのオプションの<code class=\"language-text\">--backend-store-url</code>はSQL ALchemyと同じ方法でuriを渡します．</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">mlflow</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mlflow\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">80</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n      <span class=\"token punctuation\">-</span> minio\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Tokyo\n      <span class=\"token key atrule\">VIRTUAL_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"example.com,localhost\"</span>\n      <span class=\"token key atrule\">MLFLOW_S3_ENDPOINT_URL</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//minio<span class=\"token punctuation\">:</span><span class=\"token number\">9000</span>\n      <span class=\"token key atrule\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">:</span> minio\n      <span class=\"token key atrule\">AWS_SECRET_ACCESS_KEY</span><span class=\"token punctuation\">:</span> minio\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      mlflow server \n      --backend-store-uri 'mysql+mysqldb://mlflow:mlflow@db:3306/mlflow'\n      --artifacts-destination 's3://mlflow/artifacts' \n      --serve-artifacts --host 0.0.0.0 --port 80</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span>8.0.29\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> mlflow\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Tokyo\n    <span class=\"token key atrule\">cap_add</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># https://github.com/docker-library/mysql/issues/422</span>\n      <span class=\"token punctuation\">-</span> SYS_NICE\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./mysql/data<span class=\"token punctuation\">:</span>/var/lib/mysql\n      <span class=\"token punctuation\">-</span> ./mysql/my.cnf<span class=\"token punctuation\">:</span>/etc/mysql/conf.d/my.cnf\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net</code></pre></div>\n<p>そして，MySQLの設定をコンテナ内の/etc/mysql/conf.d/my.cnfに置いておきます．<br>\nタイムアウトや文字コードの設定が付与されています．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>mysql<span class=\"token punctuation\">]</span>\ndefault-character-set<span class=\"token operator\">=</span>utf8mb4\n\n<span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span>\ncharacter-set-server<span class=\"token operator\">=</span>utf8mb4\ncollation-server<span class=\"token operator\">=</span>utf8mb4_unicode_ci\nwait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">31536000</span>\ninteractive_timeout <span class=\"token operator\">=</span> <span class=\"token number\">31536000</span></code></pre></div>\n<h3 id=\"minio\">MinIO</h3>\n<p>AWS S3互換のオブジェクトファイルストレージである，MinIOは以下の方法で建てることができます．</p>\n<p>ここで設定した<code class=\"language-text\">MINIO_ACCESS_KEY</code>と<code class=\"language-text\">MINIO_SECRET_KEY</code>はMLflowのAWSのKeyと同じになるように設定しましょう．</p>\n<p>defaultbucketでは，コンテナ起動時にMLflowの保存先バケットを作成するコマンドです．<br>\nここのentorypoint内にも，<code class=\"language-text\">MINIO_ACCESS_KEY</code>と<code class=\"language-text\">MINIO_SECRET_KEY</code>を入力するところがあるので注意してください．</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token comment\"># S3互換のストレージ</span>\n  <span class=\"token key atrule\">minio</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> minio/minio\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./minio<span class=\"token punctuation\">:</span>/export\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MINIO_ACCESS_KEY</span><span class=\"token punctuation\">:</span> minio\n      <span class=\"token key atrule\">MINIO_SECRET_KEY</span><span class=\"token punctuation\">:</span> minio\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> server /export\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net\n\n  <span class=\"token comment\"># minioコンテナ起動時にデフォルトのバケットを自動作成する</span>\n  <span class=\"token key atrule\">defaultbucket</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> minio/mc\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> minio\n    <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      /bin/sh -c \"\n      until (/usr/bin/mc config host add minio http://minio:9000 minio minio) do echo 'try to create buckets...' &amp;&amp; sleep 1; done;\n      /usr/bin/mc mb minio/mlflow;\n      /usr/bin/mc policy download minio/mlflow;\n      exit 0;\n      \"</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net</code></pre></div>\n<h3 id=\"nginx-proxy\">nginx-proxy</h3>\n<p>ここでは，MLflowにBasic認証をかけるために，nginx-proxyを立てておきます．<br>\n以下の例ではサーバーのポート5000でMLflowに接続することができます．</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">nginx-proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"5000:80\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./nginx/htpasswd<span class=\"token punctuation\">:</span>/etc/nginx/htpasswd\n      <span class=\"token punctuation\">-</span> ./nginx/certs/<span class=\"token punctuation\">:</span>/etc/nginx/certs\n      <span class=\"token punctuation\">-</span> ./nginx/conf.d/proxy.conf<span class=\"token punctuation\">:</span>/etc/nginx/conf.d/proxy.conf\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mlflow<span class=\"token punctuation\">-</span>net</code></pre></div>\n<p>今回はNginx ProxyでBasic認証をかけるため，Basic認証のuserとpasswordも用意しておきます．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># ホストPC側</span>\n<span class=\"token builtin class-name\">cd</span> nginx/htpasswd\nhtpasswd <span class=\"token parameter variable\">-c</span> <span class=\"token punctuation\">[</span>domain名<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span></code></pre></div>\n<p>jwilder/nginx-proxyでは，コンテナ内の<code class=\"language-text\">/etc/nginx/htpasswd</code>にドメイン名でファイルを置くことでBasic認証を付与することができます．</p>\n<p>また，デフォルトではnginx-proxyを介したファイルの転送には容量制限があるので，これを設定で増量しておきます．\n設定をコンテナ内の<code class=\"language-text\">/etc/nginx/conf.d/proxy.conf</code>に置くことで，設定をすることができます．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># /etc/nginx/conf.d/proxy.conf</span>\nclient_max_body_size 5g<span class=\"token punctuation\">;</span></code></pre></div>\n<p>以上でサーバーの構築は完了です．次に，実験を行うPythonスクリプト側の呼び出しを見てみましょう．</p>\n<h2 id=\"実験スクリプト\">実験スクリプト</h2>\n<p>MLflowはver. 1.24.0から，MLflowをS3にアクセスするためのProxyとすることで，artifactの保存先のS3ストレージのcredentialをクライアント側で保持する必要がなくなりました．利便的にもセキュリティ的にも楽です．\nそのため，クライアント側で持つべき情報は</p>\n<ul>\n<li>MLflow ServerのURL</li>\n<li>Basic認証のusername, password</li>\n</ul>\n<p>のみとなります．URLはスクリプト内で設定し，Basic認証の情報は環境変数に設定することでスクリプトからもServerにアクセスすることができます．</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> mlflow\n<span class=\"token keyword\">import</span> os\n\nMLFLOW_TRACKING_URI<span class=\"token operator\">=</span><span class=\"token string\">\"http://example.com:5000\"</span>\nMLFLOW_TRACKING_USERNAME<span class=\"token operator\">=</span><span class=\"token string\">\"mlflow\"</span>\nMLFLOW_TRACKING_PASSWORD<span class=\"token operator\">=</span><span class=\"token string\">\"mlflow\"</span>\n\nos<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">(</span><span class=\"token string\">\"MLFLOW_TRACKING_USERNAME\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> MLFLOW_TRACKING_USERNAME\nos<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">(</span><span class=\"token string\">\"MLFLOW_TRACKING_PASSWORD\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> MLFLOW_TRACKING_PASSWORD\n\nmlflow<span class=\"token punctuation\">.</span>set_tracking_uri<span class=\"token punctuation\">(</span>MLFLOW_TRACKING_URI<span class=\"token punctuation\">)</span></code></pre></div>\n<p>あとは通常通りMLflowを実行するだけです．</p>\n<p>以上，MLflowを完全オンプレで実行する方法でした．</p>\n<h2 id=\"参考\">参考</h2>\n<p><a href=\"https://qiita.com/MasafumiTsuyuki/items/9e03e285d4b9e0c41a7c\">https://qiita.com/MasafumiTsuyuki/items/9e03e285d4b9e0c41a7c</a></p>\n<p><a href=\"https://blog.amedama.jp/entry/mlflow-artifact-proxy\">https://blog.amedama.jp/entry/mlflow-artifact-proxy</a></p>","tableOfContents":"<ul>\n<li><a href=\"#%E5%B0%8E%E5%85%A5%E3%81%AE%E5%8B%95%E6%A9%9F\">導入の動機</a></li>\n<li><a href=\"#mlflow%E3%81%A8%E3%81%AF\">MLflowとは</a></li>\n<li><a href=\"#%E6%A7%8B%E6%88%90%E5%9B%B3\">構成図</a></li>\n<li><a href=\"#docker-compose\">Docker Compose</a></li>\n<li><a href=\"#%E5%AE%9F%E9%A8%93%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88\">実験スクリプト</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>","excerpt":"こんにちは．今回は実験管理ツールであるMLflow…","frontmatter":{"title":"MLflow Trackingをオンプレミスで構築する","date":"2022.09.05","update":"2022.09.05","category":"Tool","tags":["Python","Research","MLflow","Docker","PyTorch"]},"fields":{"slug":"/posts/2022-09-05_mlflow-onpre/"}}},"pageContext":{"id":"f59e5530-5502-5001-ac6a-97fcf92c22fa"}},"staticQueryHashes":["1123391092"],"slicesMap":{}}