{"componentChunkName":"component---src-templates-post-js","path":"/posts/2023-10-11_torchvisionv2/","result":{"data":{"site":{"siteMetadata":{"title":"MJUN Tech Note","author":"Junya Morioka"}},"markdownRemark":{"id":"181f6f64-6846-5bb4-9bb8-86340967c65e","html":"<p>先日，PyTorchの画像操作系の処理がまとまったライブラリ，TorchVisionのバージョン0.16.0が公開されました．\nこのアップデートで，データ拡張でよく用いられる<code class=\"language-text\">torchvision.transforms</code>のバージョンv2のドキュメントが加筆されました．\n<code class=\"language-text\">torchvision.transforms.v2</code>自体はベータ版として0.15.0から存在していたものの，今回のアップデートでドキュメントが充実し，recommendになったことから，\n実際に以前の方法とどのように異なるのか見ていきたいと思います．\nなお，v2はまだベータ版です．0.17.0で安定版となるようです．</p>\n<ul>\n<li>リリースノート</li>\n</ul>\n<p><a href=\"https://github.com/pytorch/vision/releases/tag/v0.16.0\">https://github.com/pytorch/vision/releases/tag/v0.16.0</a></p>\n<ul>\n<li>ドキュメント</li>\n</ul>\n<p><a href=\"https://pytorch.org/vision/stable/transforms.html#v2-api-reference-recommended\">https://pytorch.org/vision/stable/transforms.html#v2-api-reference-recommended</a></p>\n<p>今後のアップデートはv2のみに行われるようなので，この機会に移行しておきたいところです．</p>\n<h2 id=\"主な変更点\">主な変更点</h2>\n<ul>\n<li>transformsの入力として物体検出のBBoxや，セグメンテーションマスク，動画を扱えるようになった点</li>\n<li>CutMixやMixUpといったデータ拡張手法に対応した点</li>\n<li>高速化</li>\n<li>任意の入力(dict, lists, tuplesなど)を受け付ける</li>\n<li>Resizeなどがtorch.uint8型を入力として受け取れる</li>\n</ul>\n<p>上記の変更点をもとに，v2では以下の方法が推奨されています．</p>\n<ul>\n<li>PIL.Image型の代わりに，Tensor型を入力とする</li>\n<li>Resizeなどを行う場合は，入力をtorch.uint8([0~255])にする</li>\n<li>Resizeはバイリニアかバイキュービックで行う</li>\n</ul>\n<h2 id=\"移行方法\">移行方法</h2>\n<p>移行方法は簡単です．今まで<code class=\"language-text\">import torchvision.transforms</code>としていたところを，<code class=\"language-text\">import torchvision.transforms.v2</code>とするだけです．</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># V1</span>\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms\n\n<span class=\"token comment\"># V2(transformsのままv2を呼び出す場合)</span>\n<span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>transforms <span class=\"token keyword\">import</span> v2 <span class=\"token keyword\">as</span> transforms</code></pre></div>\n<h2 id=\"実験1-変換速度の計測\">実験1: 変換速度の計測</h2>\n<p>前述した通り，V2ではtransformsの高速化やuint8型への対応が変更点として挙げられています．\nそこで，v1, v2で速度の計測を行ってみたいと思います．</p>\n<p>v1, v2について，PIL.ImageとTensor型で入力した場合でそれぞれ比較してみます．</p>\n<p>入力画像として以下を用意しました．\nResizeの効果を見たいので，大きめのサイズの画像を用意しました．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA9hAAAPYQGoP6dpAAADBElEQVR42rWUS0yTaRSG/40u1BgUKZWpvUChCBEpLVQKVazW1kJRa1GQwUIF1FpFR8wg4AwSvIAXUPGCiBA1hujCyywmmczCsHDiFMQLEsPNS0JiYkyI6/59DChRJ5kRF/MmT07y5Ts5m/Mcgf9IMBicYDyiKBIQxYn6b4z/FSabvsVUI0xMDgQIiB8R/8H4WzAoMjg0Qs/jPp70PaNvYICng8P0D71kYGSUvufDDI4MM/Z+DGGqk12eUsLsdtQWKwrzGhakZ6LNzmdRVjHumho8h3ZyqbMd4be7t/D63ByoLaO8ysexk/toOLGXhqN7aTlfxYGD22lta6Tg5/1EOPNQWh3I9E4U6WuJt2zA7t1FYY2PhJU6Lna0ItQe3s/02QIa7XQ0phkY9FIyzBHYcudjy5QyN1zA7kihsKweSZIDuclCVLIFyeJ01FmbOXazgzNtp/CVe3na/wShrq6akFCBRGM4JtNCSvMKqdzupXjrcpZZZBhSQ3EX2sjZWESIXIsiw06E1oBieRaypTbs2ypp/eN3Gm9cpqv7PkJz03GUipkk6ZTsdHu42tJCZ9s5ikqM6I0SVPEz8Gyxk7VuHbPCNESlZSOJSyF6xUYS83YTvSIftSMXd/WvvBh9jdB8+gSGRBVWYwolmwq4dbmdk/W7SDDPYqUrnsUZcsp2uMjJLSVcsZRYyyai05zIdKuJSd+KNM5KqH4Jzp/2MPruDULb+SYMcfMx6xOwLdFTkrmKfIeByOhpRMXMRJ4cSnnVj1RXdpBo8KAxrkFn3owqaS1qaw7KZCdz5CkkuLbRNdiLcL/rHu3NDdy5fpErzfWcPfILN1vP0H66jtoKH949RVy7foGKiuOESDSoFq4ibtl61EYXP5hSURptRKYWEJNdwF3/n1Pfwy3F+5gTFotUrkUar0NhMCGNjWGuTMY8lYZIWxqd925/od6kj1/5GfjkqMjQ0Cv8/kf4e3t50N3Ng4fd+B/20NPzN37/Xzwb6eft2Nv/weXvujbjzge+cD/wmclr8wFWImVi6GBNGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"otter\"\n        title=\"\"\n        src=\"/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png\"\n        srcset=\"/static/5579417ef5b99f937dc7a608bd4161d1/772e8/torchvisionv2_2.png 200w,\n/static/5579417ef5b99f937dc7a608bd4161d1/e17e5/torchvisionv2_2.png 400w,\n/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>引用: <a href=\"https://publicdomainq.net/otter-animal-0014492/\">https://publicdomainq.net/otter-animal-0014492/</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">identify image.jpg\nimage.jpg JPEG 3872x2592 3872x2592+0+0 <span class=\"token number\">8</span>-bit sRGB <span class=\"token number\">1</span>.93051MiB <span class=\"token number\">0</span>.000u <span class=\"token number\">0</span>:00.001</code></pre></div>\n<p>測定したコードは以下です．</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> torchvision\n<span class=\"token keyword\">import</span> torchvision<span class=\"token punctuation\">.</span>transforms <span class=\"token keyword\">as</span> v1\n<span class=\"token keyword\">import</span> torchvision<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>v2 <span class=\"token keyword\">as</span> v2\n<span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_v1_transforms_tensor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> v1<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            v1<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>RandomVerticalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>RandomResizedCrop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> antialias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_v2_transforms_tensor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> v2<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            v2<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomVerticalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomResizedCrop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> antialias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>ToDtype<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>float32<span class=\"token punctuation\">,</span> scale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_v1_transforms_pil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> v1<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            v1<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>RandomVerticalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>RandomResizedCrop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> antialias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v1<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_v2_transforms_pil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> v2<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            v2<span class=\"token punctuation\">.</span>ToImage<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomVerticalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomResizedCrop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> antialias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>ToDtype<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>float32<span class=\"token punctuation\">,</span> scale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    num_iter <span class=\"token operator\">=</span> <span class=\"token number\">200</span>\n\n    transforms <span class=\"token operator\">=</span> get_v1_transforms_tensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_iter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        img <span class=\"token operator\">=</span> torchvision<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>read_image<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image.jpg\"</span><span class=\"token punctuation\">)</span>\n\n        t <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        img <span class=\"token operator\">=</span> img <span class=\"token operator\">/</span> <span class=\"token number\">255</span>\n        transforms<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n        elapsed_times<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> t<span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> elapsed_times<span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"V1 Elapsed Time(Input Tensor): \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">)</span>\n\n    transforms <span class=\"token operator\">=</span> get_v2_transforms_tensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_iter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        img <span class=\"token operator\">=</span> torchvision<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>read_image<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image.jpg\"</span><span class=\"token punctuation\">)</span>\n\n        t <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        transforms<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n        elapsed_times<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> t<span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> elapsed_times<span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"V2 Elapsed Time(Input Tensor): \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">)</span>\n\n    transforms <span class=\"token operator\">=</span> get_v1_transforms_pil<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_iter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        img <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image.jpg\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span><span class=\"token string\">\"RGB\"</span><span class=\"token punctuation\">)</span>\n        t <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        transforms<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n        elapsed_times<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> t<span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> elapsed_times<span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"V1 Elapsed Time(Input PIL): \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">)</span>\n\n    transforms <span class=\"token operator\">=</span> get_v2_transforms_pil<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_iter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        img <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image.jpg\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span><span class=\"token string\">\"RGB\"</span><span class=\"token punctuation\">)</span>\n        t <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        transforms<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n        elapsed_times<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> t<span class=\"token punctuation\">)</span>\n    elapsed_times <span class=\"token operator\">=</span> elapsed_times<span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"V2 Elapsed Time(Input PIL): \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>elapsed_times<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>実行結果は以下となりました．</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python exp.py\nV1 Elapsed Time<span class=\"token punctuation\">(</span>Input Tensor<span class=\"token punctuation\">)</span>:  <span class=\"token number\">42.47044086456299</span> ms\nV2 Elapsed Time<span class=\"token punctuation\">(</span>Input Tensor<span class=\"token punctuation\">)</span>:  <span class=\"token number\">4.662487506866455</span> ms\nV1 Elapsed Time<span class=\"token punctuation\">(</span>Input PIL<span class=\"token punctuation\">)</span>:  <span class=\"token number\">63.41712474822998</span> ms\nV2 Elapsed Time<span class=\"token punctuation\">(</span>Input PIL<span class=\"token punctuation\">)</span>:  <span class=\"token number\">13.053297996520996</span> ms</code></pre></div>\n<p>まとめると以下です．</p>\n<table>\n<thead>\n<tr>\n<th>version</th>\n<th>Input</th>\n<th align=\"right\">elapsed time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>v1</td>\n<td>Tensor</td>\n<td align=\"right\">42.4704</td>\n</tr>\n<tr>\n<td>v2</td>\n<td>Tensor</td>\n<td align=\"right\">4.6625</td>\n</tr>\n<tr>\n<td>v1</td>\n<td>PIL</td>\n<td align=\"right\">63.4171</td>\n</tr>\n<tr>\n<td>v2</td>\n<td>PIL</td>\n<td align=\"right\">13.0533</td>\n</tr>\n</tbody>\n</table>\n<p>今回の場合は，Tensorを入力した場合は9.1倍，PILを入力した場合は4.9倍の高速化となりました．\nだいぶ早いですね〜．</p>\n<h2 id=\"実験2-boxを入力してみる\">実験2: Boxを入力してみる</h2>\n<p>今までのtransformsは，画像しか入力できませんでしたが，今回からBBoxやmaskを入力できるようになったみたいです．\nというわけで，今回は簡単に用意できるBBoxを使って実験してみようと思います．</p>\n<p>以下のコードは公式のTutorialから拝借しました．</p>\n<p><a href=\"https://pytorch.org/vision/stable/auto_examples/transforms/plot_transforms_getting_started.html\">https://pytorch.org/vision/stable/auto_examples/transforms/plot_transforms_getting_started.html</a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> tv_tensors\n<span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>io <span class=\"token keyword\">import</span> read_image\n<span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>transforms <span class=\"token keyword\">import</span> v2\n<span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>v2 <span class=\"token keyword\">import</span> functional <span class=\"token keyword\">as</span> F\n<span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>utils <span class=\"token keyword\">import</span> draw_bounding_boxes<span class=\"token punctuation\">,</span> draw_segmentation_masks\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">plot</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">,</span> row_title<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>imshow_kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Make a 2d grid even if there's just 1 row</span>\n        imgs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>imgs<span class=\"token punctuation\">]</span>\n\n    num_rows <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">)</span>\n    num_cols <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    _<span class=\"token punctuation\">,</span> axs <span class=\"token operator\">=</span> plt<span class=\"token punctuation\">.</span>subplots<span class=\"token punctuation\">(</span>nrows<span class=\"token operator\">=</span>num_rows<span class=\"token punctuation\">,</span> ncols<span class=\"token operator\">=</span>num_cols<span class=\"token punctuation\">,</span> squeeze<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> row_idx<span class=\"token punctuation\">,</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> col_idx<span class=\"token punctuation\">,</span> img <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            boxes <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n            masks <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token builtin\">tuple</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                img<span class=\"token punctuation\">,</span> target <span class=\"token operator\">=</span> img\n                <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    boxes <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"boxes\"</span><span class=\"token punctuation\">)</span>\n                    masks <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"masks\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">elif</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> tv_tensors<span class=\"token punctuation\">.</span>BoundingBoxes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    boxes <span class=\"token operator\">=</span> target\n                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">raise</span> ValueError<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Unexpected target type: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            img <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>to_image<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> img<span class=\"token punctuation\">.</span>dtype<span class=\"token punctuation\">.</span>is_floating_point <span class=\"token keyword\">and</span> img<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                <span class=\"token comment\"># Poor man's re-normalization for the colors to be OK-ish. This</span>\n                <span class=\"token comment\"># is useful for images coming out of Normalize()</span>\n                img <span class=\"token operator\">-=</span> img<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                img <span class=\"token operator\">/=</span> img<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            img <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>to_dtype<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>uint8<span class=\"token punctuation\">,</span> scale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> boxes <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n                img <span class=\"token operator\">=</span> draw_bounding_boxes<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> boxes<span class=\"token punctuation\">,</span> colors<span class=\"token operator\">=</span><span class=\"token string\">\"yellow\"</span><span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> masks <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n                img <span class=\"token operator\">=</span> draw_segmentation_masks<span class=\"token punctuation\">(</span>\n                    img<span class=\"token punctuation\">,</span> masks<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> colors<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"green\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> masks<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">0.65</span>\n                <span class=\"token punctuation\">)</span>\n\n            ax <span class=\"token operator\">=</span> axs<span class=\"token punctuation\">[</span>row_idx<span class=\"token punctuation\">,</span> col_idx<span class=\"token punctuation\">]</span>\n            ax<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">.</span>permute<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>numpy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>imshow_kwargs<span class=\"token punctuation\">)</span>\n            ax<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>xticklabels<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> yticklabels<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> xticks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> yticks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> row_title <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> row_idx <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_rows<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            axs<span class=\"token punctuation\">[</span>row_idx<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>ylabel<span class=\"token operator\">=</span>row_title<span class=\"token punctuation\">[</span>row_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    plt<span class=\"token punctuation\">.</span>tight_layout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    img <span class=\"token operator\">=</span> read_image<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image.jpg\"</span><span class=\"token punctuation\">)</span>\n\n    boxes <span class=\"token operator\">=</span> tv_tensors<span class=\"token punctuation\">.</span>BoundingBoxes<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2540</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2540</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"XYXY\"</span><span class=\"token punctuation\">,</span>\n        canvas_size<span class=\"token operator\">=</span>img<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    transforms <span class=\"token operator\">=</span> v2<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            v2<span class=\"token punctuation\">.</span>RandomResizedCrop<span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> antialias<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomPhotometricDistort<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            v2<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    out_img<span class=\"token punctuation\">,</span> out_boxes <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> boxes<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>boxes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>out_boxes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    plot<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> boxes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>out_img<span class=\"token punctuation\">,</span> out_boxes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>結果は以下のようになります．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA9hAAAPYQGoP6dpAAADBElEQVR42rWUS0yTaRSG/40u1BgUKZWpvUChCBEpLVQKVazW1kJRa1GQwUIF1FpFR8wg4AwSvIAXUPGCiBA1hujCyywmmczCsHDiFMQLEsPNS0JiYkyI6/59DChRJ5kRF/MmT07y5Ts5m/Mcgf9IMBicYDyiKBIQxYn6b4z/FSabvsVUI0xMDgQIiB8R/8H4WzAoMjg0Qs/jPp70PaNvYICng8P0D71kYGSUvufDDI4MM/Z+DGGqk12eUsLsdtQWKwrzGhakZ6LNzmdRVjHumho8h3ZyqbMd4be7t/D63ByoLaO8ysexk/toOLGXhqN7aTlfxYGD22lta6Tg5/1EOPNQWh3I9E4U6WuJt2zA7t1FYY2PhJU6Lna0ItQe3s/02QIa7XQ0phkY9FIyzBHYcudjy5QyN1zA7kihsKweSZIDuclCVLIFyeJ01FmbOXazgzNtp/CVe3na/wShrq6akFCBRGM4JtNCSvMKqdzupXjrcpZZZBhSQ3EX2sjZWESIXIsiw06E1oBieRaypTbs2ypp/eN3Gm9cpqv7PkJz03GUipkk6ZTsdHu42tJCZ9s5ikqM6I0SVPEz8Gyxk7VuHbPCNESlZSOJSyF6xUYS83YTvSIftSMXd/WvvBh9jdB8+gSGRBVWYwolmwq4dbmdk/W7SDDPYqUrnsUZcsp2uMjJLSVcsZRYyyai05zIdKuJSd+KNM5KqH4Jzp/2MPruDULb+SYMcfMx6xOwLdFTkrmKfIeByOhpRMXMRJ4cSnnVj1RXdpBo8KAxrkFn3owqaS1qaw7KZCdz5CkkuLbRNdiLcL/rHu3NDdy5fpErzfWcPfILN1vP0H66jtoKH949RVy7foGKiuOESDSoFq4ibtl61EYXP5hSURptRKYWEJNdwF3/n1Pfwy3F+5gTFotUrkUar0NhMCGNjWGuTMY8lYZIWxqd925/od6kj1/5GfjkqMjQ0Cv8/kf4e3t50N3Ng4fd+B/20NPzN37/Xzwb6eft2Nv/weXvujbjzge+cD/wmclr8wFWImVi6GBNGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"box\"\n        title=\"\"\n        src=\"/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png\"\n        srcset=\"/static/5579417ef5b99f937dc7a608bd4161d1/772e8/torchvisionv2_2.png 200w,\n/static/5579417ef5b99f937dc7a608bd4161d1/e17e5/torchvisionv2_2.png 400w,\n/static/5579417ef5b99f937dc7a608bd4161d1/6af66/torchvisionv2_2.png 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>上記のコード例で重要な部分はここです．</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">boxes <span class=\"token operator\">=</span> tv_tensors<span class=\"token punctuation\">.</span>BoundingBoxes<span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2540</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2540</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"XYXY\"</span><span class=\"token punctuation\">,</span>\n            canvas_size<span class=\"token operator\">=</span>img<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span></code></pre></div>\n<p>v2ではBBoxは<code class=\"language-text\">tv_tensors.BoundingBoxes</code>に，\nMaskは<code class=\"language-text\">tv_tensors.Mask</code>に入れて入力することで，Box・Maskへもデータ拡張ができるようです．</p>\n<h2 id=\"まとめ\">まとめ</h2>\n<p>以上簡単にですが，torchvision.transformsのv2の紹介でした．\n実験1で示したように，Resizeをuint8で処理できるようになったこともあってか，\ntransformsの大幅な高速化がなされています．\n導入も簡単なので，torchvisio.transformsを使用している人はv2への移行を検討してみても良いのかもしれません．</p>","tableOfContents":"<ul>\n<li><a href=\"#%E4%B8%BB%E3%81%AA%E5%A4%89%E6%9B%B4%E7%82%B9\">主な変更点</a></li>\n<li><a href=\"#%E7%A7%BB%E8%A1%8C%E6%96%B9%E6%B3%95\">移行方法</a></li>\n<li><a href=\"#%E5%AE%9F%E9%A8%931-%E5%A4%89%E6%8F%9B%E9%80%9F%E5%BA%A6%E3%81%AE%E8%A8%88%E6%B8%AC\">実験1: 変換速度の計測</a></li>\n<li><a href=\"#%E5%AE%9F%E9%A8%932-box%E3%82%92%E5%85%A5%E5%8A%9B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\">実験2: Boxを入力してみる</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>","excerpt":"先日，PyTorchの画像操作系の処理がまとまったライブラリ，TorchVisionのバージョン0.16.0が公開されました．\nこのアップデートで，データ拡張でよく用いられるのバージョンv2のドキュメントが加筆されました．\n自体はベータ版として0.15.…","frontmatter":{"title":"TorchVisionのtransforms.v2を触ってみた","date":"2023.10.11","update":"2023.10.11","category":"PyTorch","tags":["PyTorch"]},"fields":{"slug":"/posts/2023-10-11_torchvisionv2/"}}},"pageContext":{"id":"181f6f64-6846-5bb4-9bb8-86340967c65e"}},"staticQueryHashes":["1123391092"],"slicesMap":{}}