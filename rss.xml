<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[MJUN Tech Note RSS Feed]]></title><description><![CDATA[とある情報系の院生の技術ノートです]]></description><link>https://note.mjunya.com</link><generator>GatsbyJS</generator><lastBuildDate>Sat, 23 Apr 2022 23:23:52 GMT</lastBuildDate><item><title><![CDATA[PyTorchのMultiGPUの概要 【DataParallel, DistributedDataParallel, torchrun】]]></title><description><![CDATA[機械学習ライブラリの PyTorch には、複数のマシン・GPU で
学習を行う方法がいくつか用意されている。 この記事を書いている現在、PyTorch の stable version は 1.11.0 であるが、
実行方法が、直近の version 1.9.0 と 1.1…]]></description><link>https://note.mjunya.com/posts/2022-04-18-torchrun/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2022-04-18-torchrun/</guid><pubDate>Mon, 18 Apr 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;機械学習ライブラリの PyTorch には、複数のマシン・GPU で
学習を行う方法がいくつか用意されている。&lt;br/&gt;
この記事を書いている現在、PyTorch の stable version は&lt;code class=&quot;language-text&quot;&gt;1.11.0&lt;/code&gt;であるが、
実行方法が、直近の version&lt;code class=&quot;language-text&quot;&gt;1.9.0&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;1.10.0&lt;/code&gt;で変更・追加があったのでまとめる。&lt;/p&gt;&lt;h2 id=&quot;dataparallel-と-distributeddataparallel&quot;&gt;DataParallel と DistributedDataParallel&lt;/h2&gt;&lt;p&gt;PyTorch で複数の GPU を用いた Training の実装方法は 2 つある。&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;torch.nn.DataParallel&lt;/code&gt;&lt;/li&gt;&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;torch.nn.DistributedDataParallel&lt;/code&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;この２つの違いは、複数の GPU に割り当てられる CPU が
Threading か Multiprocessing になるかである。&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/f267346af6b6d553c5249a7e92c166b6/f43b1/torch_dist.jpg&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:55.99999999999999%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHtTaQFf//EABkQAAIDAQAAAAAAAAAAAAAAAAABAhARMf/aAAgBAQABBQKWktQuX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABcQAAMBAAAAAAAAAAAAAAAAAAABICH/2gAIAQEABj8CRk//xAAaEAADAQADAAAAAAAAAAAAAAAAAREhEDFB/9oACAEBAAE/IXqF7GbJbzDopBpN8f/aAAwDAQACAAMAAAAQA8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAXEQEAAwAAAAAAAAAAAAAAAAABECEx/9oACAECAQE/EE24/8QAGhABAQADAQEAAAAAAAAAAAAAAREAITFxUf/aAAgBAQABPxA+7p2PPuuYytC9lrfcSoIwpiLYXzDFOY60Z//Z&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;nvidia-diff-parallel&quot; title=&quot;nvidia-diff-parallel&quot; src=&quot;/static/f267346af6b6d553c5249a7e92c166b6/4b190/torch_dist.jpg&quot; srcSet=&quot;/static/f267346af6b6d553c5249a7e92c166b6/e07e9/torch_dist.jpg 200w,/static/f267346af6b6d553c5249a7e92c166b6/066f9/torch_dist.jpg 400w,/static/f267346af6b6d553c5249a7e92c166b6/4b190/torch_dist.jpg 800w,/static/f267346af6b6d553c5249a7e92c166b6/e5166/torch_dist.jpg 1200w,/static/f267346af6b6d553c5249a7e92c166b6/f43b1/torch_dist.jpg 1426w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;上記の図&lt;sup id=&quot;fnref-1&quot;&gt;&lt;a href=&quot;#fn-1&quot; class=&quot;footnote-ref&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;のように、Python の GIL の都合もあり、
&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;を使ったほうが各 GPU に個別の CPU コアを割り当てられるので、
リソースを存分に使うことができる。
また、複数のマシン(Multi-node)で実行できるのも強みである。
実際、公式ドキュメント&lt;sup id=&quot;fnref-2&quot;&gt;&lt;a href=&quot;#fn-2&quot; class=&quot;footnote-ref&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;でも&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;が勧められている。&lt;/p&gt;&lt;p&gt;ここまでくると、&lt;code class=&quot;language-text&quot;&gt;DataParallel&lt;/code&gt;のメリットが感じられないが、実装の違いを
見ると利点が見えてくる。&lt;/p&gt;&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;DataParallel&lt;/code&gt;の実装は以下である。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torch

model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hoge&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;nn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataParallel&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; device_ids&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記のように既存のモデル(&lt;code class=&quot;language-text&quot;&gt;torch.nn.Model&lt;/code&gt;)に対して、&lt;code class=&quot;language-text&quot;&gt;torch.nn.DataParallel&lt;/code&gt;をラップするだけで
実装でき、既存のコードを 1 行変更するだけで実装することができる。&lt;/p&gt;&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;の実装例を確認する。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; os
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torch
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;distributed &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; dist
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;nn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parallel &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; DistributedDataParallel &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; DDP
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;utils&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;distributed &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; DistributedSampler

&lt;span class=&quot;token comment&quot;&gt;# どのGPUプロセス番号かがLocal Rank&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# GPU ID = 1の時、local_rank=1&lt;/span&gt;
local_rank &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getenv&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;LOCAL_RANK&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# 通信方法の規定とプロセスグループの初期化&lt;/span&gt;
dist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;init_process_group&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;backend&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;nccl&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; init_method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;env://&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

dataset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Dataset&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hoge&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# DistributedSamplerを使う&lt;/span&gt;
sampler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DistributedSampler&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataset&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; rank&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;local_rank&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
dataloaders &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;utils&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataLoader&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dataset&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                                          batch_size&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                                          sampler&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;Distributed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# DistributedDataParallelでラップ&lt;/span&gt;
model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Model&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fuga&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DDP&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Training終了&lt;/span&gt;
dist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;destroy_process_group&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;では、シングル・マルチマシンの場合も同じ書き方ができるように
設計されているため、新たに実装する部分が多い。
マルチプロセスになった分、自分が今どのプロセスにいるのかを意識しながら実装を進める必要がある。&lt;/p&gt;&lt;p&gt;上記の通り、&lt;code class=&quot;language-text&quot;&gt;DataParallel&lt;/code&gt;は 1 行で既存のコードを変更することができるが、
&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;は多少の追加実装が必要になる。
手軽に複数 GPU での Training を試したい場合は、&lt;code class=&quot;language-text&quot;&gt;DataParallel&lt;/code&gt;を用いるとよい。&lt;/p&gt;&lt;p&gt;次章では新たに追加された&lt;code class=&quot;language-text&quot;&gt;torchrun&lt;/code&gt;について議論するため、以下からは&lt;code class=&quot;language-text&quot;&gt;DistributedDataParallel&lt;/code&gt;
を用いた場合について考える。&lt;/p&gt;&lt;h2 id=&quot;distributeddataparallel-の実行方法&quot;&gt;DistributedDataParallel の実行方法&lt;/h2&gt;&lt;p&gt;DistributedDataParallel の実行方法は、大きく分けて以下の２つある。&lt;/p&gt;&lt;ol&gt;&lt;li&gt;特定の関数について GPU 並列化を行う方法(&lt;code class=&quot;language-text&quot;&gt;mp.spawn&lt;/code&gt;)&lt;/li&gt;&lt;li&gt;スクリプトごと GPU 並列化する方法(&lt;code class=&quot;language-text&quot;&gt;torchrun&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;torch.distributed.run&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;)&lt;/li&gt;&lt;/ol&gt;&lt;h3 id=&quot;1-関数について並列化&quot;&gt;1. 関数について並列化&lt;/h3&gt;&lt;p&gt;1 の関数ごとに並列化する方法は、コード内で Training を行う関数を書いて、使用する GPU の数や
通信方法もコード内で設定して実行することができる。
つまり、シングル GPU であっても、複数 GPU のコードであっても&lt;code class=&quot;language-text&quot;&gt;python train.py&lt;/code&gt;と、
同じコマンドの実行で学習が行える。&lt;br/&gt;
実装例は PyTorch 公式の ImageNet 学習の実装に書かれている。&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/pytorch/examples/tree/main/imagenet&quot;&gt;https://github.com/pytorch/examples/tree/main/imagenet&lt;/a&gt;&lt;/p&gt;&lt;p&gt;2 の方法と大きく異なる部分が、以下の部分である。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;multiprocessing &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; mp

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;train&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rank&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hoge&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    dist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;init_process_group&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;backend&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;nccl&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; init_method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;env://&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    mp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;spawn&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;train&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nprocs&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ngpus_per_node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hoge&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記の通り、コード自体は Python 標準モジュールの multiprocessing と変わりない。&lt;br/&gt;
しかし、標準モジュールは CUDA Initialized を複数行ってしまい、エラーが発生するため、
multiprocessing モジュールをラップした、&lt;code class=&quot;language-text&quot;&gt;torch.multiprocessing&lt;/code&gt;を使用する。&lt;/p&gt;&lt;h3 id=&quot;2-スクリプトごと並列化&quot;&gt;2. スクリプトごと並列化&lt;/h3&gt;&lt;p&gt;2 の方法については PyTorch のバージョンによって実行方法が異なっており、
version 1.9.0 以前は、&lt;br/&gt;
&lt;code class=&quot;language-text&quot;&gt;python -m torch.distributed.launch --nproc_per_node=4 --nnodes=1 --node_rank 0 train.py&lt;/code&gt;&lt;br/&gt;
で実行されていたが、version 1.9.0 以降は TorchElastic が追加された影響で&lt;br/&gt;
&lt;code class=&quot;language-text&quot;&gt;python -m torch.distributed.run --nproc_per_node=4 --nnodes=1 --node_rank 0 train.py&lt;/code&gt;&lt;br/&gt;
でも実行できる。&lt;br/&gt;
また、&lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;の super set として、&lt;code class=&quot;language-text&quot;&gt;torchrun&lt;/code&gt;が Version 1.10.0 から提供されている。&lt;/p&gt;&lt;p&gt;ここでは従来の方法である、&lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;torch.distributed.run&lt;/code&gt;について述べる。&lt;/p&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;torch.distributed.run&lt;/code&gt;の場合、
実行スクリプトの&lt;code class=&quot;language-text&quot;&gt;train.py&lt;/code&gt;にはコマンドライン引数として
&lt;code class=&quot;language-text&quot;&gt;--local_rank&lt;/code&gt;を受け取れるように実装する必要がある。下に例を示す。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; argparse
parser &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; argparse&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ArgumentParser&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add_argument&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;--local_rank&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
args &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parse_args&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

local_rank &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;local_rank&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これ以外の実装は 1 の関数ごとに multiprocessing する場合と変わらない。&lt;/p&gt;&lt;h3 id=&quot;1-と-2-の実行方法の違いについて&quot;&gt;1 と 2 の実行方法の違いについて&lt;/h3&gt;&lt;p&gt;1 の関数を multiprocessing する方法と、スクリプト自体を multiprocessing する方法は、
&lt;a href=&quot;%5E3&quot;&gt;こちらの公式フォーラム&lt;/a&gt;
&lt;sup id=&quot;fnref-3&quot;&gt;&lt;a href=&quot;#fn-3&quot; class=&quot;footnote-ref&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;でも言及されているように、
&lt;code class=&quot;language-text&quot;&gt;multiprocessing(1) vs subprocess(2)&lt;/code&gt;の違いといえる。&lt;/p&gt;&lt;p&gt;Github の Issue&lt;sup id=&quot;fnref-4&quot;&gt;&lt;a href=&quot;#fn-4&quot; class=&quot;footnote-ref&quot;&gt;4&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref-5&quot;&gt;&lt;a href=&quot;#fn-5&quot; class=&quot;footnote-ref&quot;&gt;5&lt;/a&gt;&lt;/sup&gt;では、1 の方法が GPU への転送速度の関係で遅いという報告もある。
長い時間の学習では無視できるようだが、参考としておきたい。&lt;/p&gt;&lt;h2 id=&quot;新しい実行方法-torchrun&quot;&gt;新しい実行方法 &lt;code class=&quot;language-text&quot;&gt;torchrun&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;PyTorch の Version 1.10.0 から、&lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;の super set として、&lt;code class=&quot;language-text&quot;&gt;torchrun&lt;/code&gt;が登場している。&lt;/p&gt;&lt;p&gt;公式ドキュメント&lt;sup id=&quot;fnref-6&quot;&gt;&lt;a href=&quot;#fn-6&quot; class=&quot;footnote-ref&quot;&gt;6&lt;/a&gt;&lt;/sup&gt;にわかりやすい移行手順があるので、一読をお勧めする。&lt;/p&gt;&lt;p&gt;具体的には、実行コマンドが以下のように変更され、&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# use_envはLOCAL RANKをargparseではなく、&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 環境変数から受け取るオプション&lt;/span&gt;
python -m torch.distributed.launch --use_env train_script.py

torchrun train_script.py&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;argparse で受け取っていた local rank を環境変数から受け取るようになる。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# torch.distributed.launch&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; argparse
parser &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; argparse&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ArgumentParser&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add_argument&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;--local_rank&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
args &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parse_args&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

local_rank &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;local_rank

&lt;span class=&quot;token comment&quot;&gt;# torchrun&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; os
local_rank &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;LOCAL_RANK&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ほとんど使用感は変わりないが、わざわざ argparse で引数の受取先を作らなくてよくなったのは、
コマンドライン引数の名前空間を汚されなくて済むので利点がある。&lt;br/&gt;
例えば、Facebook 謹製の設定管理ライブラリの
&lt;a href=&quot;https://hydra.cc/&quot;&gt;Hydra&lt;/a&gt; &lt;sup id=&quot;fnref-7&quot;&gt;&lt;a href=&quot;#fn-7&quot; class=&quot;footnote-ref&quot;&gt;7&lt;/a&gt;&lt;/sup&gt;を使っている場合、argparse と併用ができないので、
torchrun で環境変数を経由するメリットがある。&lt;br/&gt;
(ただし、ここ&lt;sup id=&quot;fnref-8&quot;&gt;&lt;a href=&quot;#fn-8&quot; class=&quot;footnote-ref&quot;&gt;8&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref-9&quot;&gt;&lt;a href=&quot;#fn-9&quot; class=&quot;footnote-ref&quot;&gt;9&lt;/a&gt;&lt;/sup&gt;で議論されているように、output 周りが conflict する問題があるので、
今後の動向に注目するべきである。)&lt;/p&gt;&lt;p&gt;ここ&lt;sup id=&quot;fnref-10&quot;&gt;&lt;a href=&quot;#fn-10&quot; class=&quot;footnote-ref&quot;&gt;10&lt;/a&gt;&lt;/sup&gt;で、書かれているように&lt;code class=&quot;language-text&quot;&gt;torch.distributed.launch&lt;/code&gt;
は将来的に deprecated したいようなので、今後は torchrun で実装していくべきだろう。&lt;/p&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;div class=&quot;footnotes&quot;&gt;&lt;hr/&gt;&lt;ol&gt;&lt;li id=&quot;fn-1&quot;&gt;&lt;a href=&quot;https://qiita.com/sugulu_Ogawa_ISID/items/62f5f7adee083d96a587#4-multi-gpu%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;https://qiita.com/sugulu_Ogawa_ISID/items/62f5f7adee083d96a587#4-multi-gpu%E3%81%AE%E8%A8%AD%E5%AE%9A&lt;/a&gt;&lt;a href=&quot;#fnref-1&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-2&quot;&gt;&lt;a href=&quot;https://pytorch.org/docs/1.11/notes/cuda.html#use-nn-parallel-distributeddataparallel-instead-of-multiprocessing-or-nn-dataparallel&quot;&gt;https://pytorch.org/docs/1.11/notes/cuda.html#use-nn-parallel-distributeddataparallel-instead-of-multiprocessing-or-nn-dataparallel&lt;/a&gt;&lt;a href=&quot;#fnref-2&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-3&quot;&gt;&lt;a href=&quot;https://discuss.pytorch.org/t/torch-distributed-launch-vs-torch-multiprocessing-spawn/95738&quot;&gt;https://discuss.pytorch.org/t/torch-distributed-launch-vs-torch-multiprocessing-spawn/95738&lt;/a&gt;&lt;a href=&quot;#fnref-3&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-4&quot;&gt;&lt;a href=&quot;https://github.com/pytorch/pytorch/issues/47587&quot;&gt;https://github.com/pytorch/pytorch/issues/47587&lt;/a&gt;&lt;a href=&quot;#fnref-4&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-5&quot;&gt;&lt;a href=&quot;https://github.com/NVIDIA/apex/issues/549&quot;&gt;https://github.com/NVIDIA/apex/issues/549&lt;/a&gt;&lt;a href=&quot;#fnref-5&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-6&quot;&gt;&lt;a href=&quot;https://pytorch.org/docs/1.11/elastic/run.html&quot;&gt;https://pytorch.org/docs/1.11/elastic/run.html&lt;/a&gt;&lt;a href=&quot;#fnref-6&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-7&quot;&gt;&lt;a href=&quot;https://hydra.cc/&quot;&gt;https://hydra.cc/&lt;/a&gt;&lt;a href=&quot;#fnref-7&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-8&quot;&gt;&lt;a href=&quot;https://github.com/facebookresearch/hydra/pull/2119&quot;&gt;https://github.com/facebookresearch/hydra/pull/2119&lt;/a&gt;&lt;a href=&quot;#fnref-8&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-9&quot;&gt;&lt;a href=&quot;https://github.com/facebookresearch/hydra/issues/2038&quot;&gt;https://github.com/facebookresearch/hydra/issues/2038&lt;/a&gt;&lt;a href=&quot;#fnref-9&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;li id=&quot;fn-10&quot;&gt;&lt;a href=&quot;https://pytorch.org/docs/1.11/distributed.html#launch-utility&quot;&gt;https://pytorch.org/docs/1.11/distributed.html#launch-utility&lt;/a&gt;&lt;a href=&quot;#fnref-10&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[UbuntuでGitLabをapache経由でproxyする]]></title><description><![CDATA[今回はUbuntuでApacheを使ってGitlabをサブディレクトリで立てる方法です． SSL証明書はGitLabではなく，Apacheとcertbotで管理します．   今回のゴールは， https://hoge.com/gitlab にGitLab…]]></description><link>https://note.mjunya.com/posts/2022-04-05-gitlab-apache/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2022-04-05-gitlab-apache/</guid><pubDate>Tue, 05 Apr 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回はUbuntuでApacheを使ってGitlabをサブディレクトリで立てる方法です．&lt;br/&gt;
SSL証明書はGitLabではなく，Apacheとcertbotで管理します．  &lt;/p&gt;&lt;p&gt;今回のゴールは，&lt;code class=&quot;language-text&quot;&gt;https://hoge.com/gitlab&lt;/code&gt;にGitLabを立てることです．&lt;/p&gt;&lt;h2 id=&quot;apacheのインストール&quot;&gt;apacheのインストール&lt;/h2&gt;&lt;p&gt;まずはapache2のインストール．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; apache2
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl status apache&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;certbotの導入&quot;&gt;certbotの導入&lt;/h2&gt;&lt;p&gt;次にcertbotを導入します．予め，登録用のメールアドレスとドメインを用意してください．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; certbot python3-certbot-apache
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; certbot --apache

Enter email address &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;used &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; urgent renewal and security notices&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Enter &lt;span class=&quot;token string&quot;&gt;&amp;#x27;c&amp;#x27;&lt;/span&gt; to
cancel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: hoge@hoge.com

You must agree &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; order to register with the ACME server at
https://acme-v02.api.letsencrypt.org/directory
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;gree/&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;C&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ancel: A

Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let s Encrypt project and the non-profit
organization that develops Certbot?
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Y&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;es/&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;o: N

Which names would you like to activate HTTPS for?
----------------------------------------
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;: hoge.com
----------------------------------------
 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Enter &lt;span class=&quot;token string&quot;&gt;&amp;#x27;c&amp;#x27;&lt;/span&gt; to cancel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
----------------------------------------
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;: No redirect
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;: Redirect
----------------------------------------
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;press &lt;span class=&quot;token string&quot;&gt;&amp;#x27;c&amp;#x27;&lt;/span&gt; to cancel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;

Congratulations&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; You have successfully enabled https://hoge.com

&lt;span class=&quot;token comment&quot;&gt;# 自動更新が働いているかを確認&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl status certbot.timer&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;apacheの設定&quot;&gt;apacheの設定&lt;/h2&gt;&lt;p&gt;次に，apacheにProxyの設定をします．&lt;br/&gt;
&lt;code class=&quot;language-text&quot;&gt;/etc/apache2/sites-enabled/000-default-le-ssl.conf&lt;/code&gt;に以下を加筆します．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ProxyPass /gitlab http://localhost:8000/gitlab
ProxyPassReverse /gitlab http://localhost:8000/gitlab&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ついでにapacheのバージョンが外から見えないように，&lt;code class=&quot;language-text&quot;&gt;/etc/apache2/conf-enabled/security.conf&lt;/code&gt;を編集します．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ServerTokens Prod
ServerSignature Off&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;設定が終わったら，apacheを再起動します．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart apache&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;gitlabの立ち上げ&quot;&gt;GitLabの立ち上げ&lt;/h2&gt;&lt;p&gt;今回はdocker-composeでGitLabを立ち上げます．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;3.7&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;gitlab&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; gitlab/gitlab&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ce&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;14.7.7&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ce.0
    &lt;span class=&quot;token key atrule&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; always
    &lt;span class=&quot;token key atrule&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;hoge.com&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;GITLAB_OMNIBUS_CONFIG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
        external_url &amp;#x27;http://hoge.com/gitlab/&amp;#x27;
        gitlab_rails[&amp;#x27;gitlab_shell_ssh_port&amp;#x27;] = 22
        gitlab_rails[&amp;#x27;time_zone&amp;#x27;] = &amp;#x27;Asia/Tokyo&amp;#x27;
        letsencrypt[&amp;#x27;enable&amp;#x27;] = false
        nginx[&amp;#x27;listen_port&amp;#x27;] = 8088&lt;/span&gt;

    &lt;span class=&quot;token key atrule&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;8000:8000&amp;#x27;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;22:22&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/data&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/var/opt/gitlab
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/logs&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/var/log/gitlab
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/config&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/etc/gitlab&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;SSL証明書はapacheで管理するので，&lt;code class=&quot;language-text&quot;&gt;letsencrypt[&amp;#x27;enable&amp;#x27;] = false&lt;/code&gt;としておきます．  &lt;/p&gt;&lt;p&gt;以上でapache経由で任意のサブディレクトリでGitLabにアクセスできます．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[docker-composeのGitlabのメール通知をGoogle WorkspaceのSMTPリレーで行う]]></title><description><![CDATA[私はクレデンシャルなソースコードを管理するために，自宅サーバでGitLabをセルフホストしています． 基本的にユーザーは自分しかいないのですが，メール通知があったほうが便利かと思い，メールを設定することにしました． ちょうど，このサイトのドメインを使ってGoogle…]]></description><link>https://note.mjunya.com/posts/2022-04-04-gitlab-mail-google-smtp-relay/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2022-04-04-gitlab-mail-google-smtp-relay/</guid><pubDate>Mon, 04 Apr 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;私はクレデンシャルなソースコードを管理するために，自宅サーバでGitLabをセルフホストしています．&lt;br/&gt;
基本的にユーザーは自分しかいないのですが，メール通知があったほうが便利かと思い，メールを設定することにしました．&lt;/p&gt;&lt;p&gt;ちょうど，このサイトのドメインを使ってGoogle Workspaceを契約しているので，提供されているSMTPリレーサービスを使って，
Google経由でメール通知を行うことにします．&lt;/p&gt;&lt;h2 id=&quot;op25b問題について&quot;&gt;OP25B問題について&lt;/h2&gt;&lt;p&gt;自宅サーバーでメールの送信を行うのに問題になるのが「OP25B」です．  &lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html&quot;&gt;https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html&lt;/a&gt;&lt;/p&gt;&lt;p&gt;これは迷惑メール対策のために，プロバイダーが自宅からのメール送信をブロックしてしまう問題です．&lt;br/&gt;
これを回避するためにプロバイダが用意しているSMTPリレーサーバを中継してメールを送信するのですが，
そもそもSMTPサーバが提供されていなかったり，制限があることがあります．&lt;br/&gt;
そこで，今回は独自ドメイン内なら制限の緩い，Google WorkspaceのSMTPリレーサービスを使うことにします．&lt;/p&gt;&lt;h2 id=&quot;google-workspaceの設定&quot;&gt;Google Workspaceの設定&lt;/h2&gt;&lt;p&gt;まずは，Google Workspaceの管理コンソールへ行きます．&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://support.google.com/a/answer/2956491?hl=ja&quot;&gt;https://support.google.com/a/answer/2956491?hl=ja&lt;/a&gt;&lt;/p&gt;&lt;p&gt;上記のサイトに書かれているように，
管理コンソールから、アプリ-&amp;gt;Google Workspace-&amp;gt;Gmail-&amp;gt;ルーティングと進み，SMTPリレーサービスの設定画面を開きます．&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/171fdd08be73f0906ca6c8017eec88b9/0d98f/2022-04-04-gitlab.png&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:93.5%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAABv0lEQVQ4y61UyUoDQRCdf9G7f6Cg4kXxB/TqScGDmu9SJCG5ihhNUPQgaJaDJGbV2Sez9jy7Os44JmM2bHh0UzP16lV1VUsbx2Vsn91jh2M384DVwxLWCEflhSCtHLxg87SG9ZMqtjI1LO0/z4+94b7MIWWLMs6veri8kXFx/YFc8RP5OwWFkor8jCiUVeRuFWSLCiTAA3M1AO4QzOI7wyIrYCEkWdFQqdZhOx6CIITvM/jBYiB/iTE6BL8ihWEIshPoPA8kIZUTmqYpoKqq+JAkn2cJQtd10el00G63Ua/XY3LLsmLSiDhSn7SPKaSD4ziwbVsQDQYDaJomzmmOScJUhUTQ4ur+Y/0otA2hitKM1FIgXdeFjWrb6/WEbbQMY4SM98/rm45Gs4X3ZlPUs9vtCgIKQuSGYUBRFBFs0mVxQooEPNa4GsPiBKpwjNSmOU66eaFQKFDa/Me/JyR5KVMU0sgwPNV4SqrOa6bxVPuQZRn9/nD3PG/mnoxTrjQcmBZdhCXSpZpFu+/7qf2Y2ofD79Mjzzo9cduwKTM6qpCam0pBU0Y2YxDwB+J7UuZZESGVgXqSOoHI+6oPj79UX2ToklO0JJ6QAAAAAElFTkSuQmCC&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;smtp&quot; title=&quot;smtp&quot; src=&quot;/static/171fdd08be73f0906ca6c8017eec88b9/5a190/2022-04-04-gitlab.png&quot; srcSet=&quot;/static/171fdd08be73f0906ca6c8017eec88b9/772e8/2022-04-04-gitlab.png 200w,/static/171fdd08be73f0906ca6c8017eec88b9/e17e5/2022-04-04-gitlab.png 400w,/static/171fdd08be73f0906ca6c8017eec88b9/5a190/2022-04-04-gitlab.png 800w,/static/171fdd08be73f0906ca6c8017eec88b9/c1b63/2022-04-04-gitlab.png 1200w,/static/171fdd08be73f0906ca6c8017eec88b9/0d98f/2022-04-04-gitlab.png 1276w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;上記のように，&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ドメイン内のアドレスのみ&lt;/li&gt;&lt;li&gt;SMTP認証を必須とする&lt;/li&gt;&lt;li&gt;TLSによる暗号化を有効にする&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;を設定します．&lt;/p&gt;&lt;p&gt;次に，Googleアカウントに2段階認証を設定している場合は，
アカウント設定で，アプリパスワードを発行します．&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/45fa3ae80c85e142272849d270a3d6d7/966c1/google_app_password.png&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:37.5%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFklEQVQoz4WSPU7EMBCFc1xaelqOgCjRStR0SDT8iGIPgDgAQkqBE+9mndiOf8aPsXeDFjYRlkZJZsZfnt+4stbCOQdjDJRS5Z0o/ROEGD1HhPMRPtBPrarrGk3TYNt1aNsWwzAgpYSllWs2AJbAsNzHH4icp1Kvljb9jWlFVmfkB+z7JV6f73D1ILF6ERCd3QOz7HyEuc3HP8jHyaUYRoxv1zDrMzw93uP8RuDi9hN1ewBqrdmDsKyOc0QRfa+wUz20HmD9vB1ZXCWEgJQSqu8RGHwMo6I2wTjCVzeyOl9yFLmPQvEt/hoUAzNss9myguEEmA7Akc1vdxbB+xN7aHpOwHxd9mFnh1GgHMbo0uO9XxxcBn4DtgFvqUC9y38AAAAASUVORK5CYII=&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;google_app&quot; title=&quot;google_app&quot; src=&quot;/static/45fa3ae80c85e142272849d270a3d6d7/5a190/google_app_password.png&quot; srcSet=&quot;/static/45fa3ae80c85e142272849d270a3d6d7/772e8/google_app_password.png 200w,/static/45fa3ae80c85e142272849d270a3d6d7/e17e5/google_app_password.png 400w,/static/45fa3ae80c85e142272849d270a3d6d7/5a190/google_app_password.png 800w,/static/45fa3ae80c85e142272849d270a3d6d7/c1b63/google_app_password.png 1200w,/static/45fa3ae80c85e142272849d270a3d6d7/29007/google_app_password.png 1600w,/static/45fa3ae80c85e142272849d270a3d6d7/966c1/google_app_password.png 1694w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;このアプリパスワードを使ってSMTP認証を行ってメールを送信します．&lt;/p&gt;&lt;h2 id=&quot;gitlab-docker-composeymlの設定&quot;&gt;GitLab docker-compose.ymlの設定&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;3.7&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;gitlab&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; gitlab/gitlab&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ce&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;14.7.2&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;ce.0
    &lt;span class=&quot;token key atrule&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; always
    &lt;span class=&quot;token key atrule&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;hoge.com&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;GITLAB_OMNIBUS_CONFIG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token scalar string&quot;&gt;
        external_url &amp;#x27;http://hoge.com&amp;#x27;
        gitlab_rails[&amp;#x27;time_zone&amp;#x27;] = &amp;#x27;Asia/Tokyo&amp;#x27;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;# mail&lt;/span&gt;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_enable&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = true
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_address&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &amp;quot;smtp&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;relay.gmail.com&amp;quot;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_port&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = 587
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_domain&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;独自ドメイン or gmail.com&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_authentication&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &amp;quot;login&amp;quot;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_user_name&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Googleアカウントのユーザー名&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;smtp_password&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Googleアカウントのパスワード or アプリパスワード&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;gitlab_email_from&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &amp;#x27;gitlab@gmail.com&amp;#x27;
        gitlab_rails&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;gitlab_email_reply_to&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; = &amp;#x27;noreply@gmail.com&amp;#x27;
    &lt;span class=&quot;token key atrule&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;80:80&amp;#x27;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;22:22&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/data&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/var/opt/gitlab
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/logs&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/var/log/gitlab
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ./gitlab/config&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/etc/gitlab&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記のように，docker-compose.yamlを編集して，起動すれば設定は以上です．&lt;/p&gt;&lt;p&gt;メールの送信ができているかは，GitLabアカウントのメールアドレス認証をやってみると良いです．&lt;/p&gt;&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html&quot;&gt;https://www.ntt.com/personal/services/option/mail/ocnmail/meiwaku/op25b.html&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://support.google.com/a/answer/2956491?hl=ja&quot;&gt;https://support.google.com/a/answer/2956491?hl=ja&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://docs.gitlab.com/omnibus/settings/smtp.html&quot;&gt;https://docs.gitlab.com/omnibus/settings/smtp.html&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Dockerfile内で任意のバージョンのPythonをソースからビルドする]]></title><description><![CDATA[コンテナ内で自由にバージョンを指定して Python を使いたいときがある． 方法としては以下が考えられる． apt などでインストールする pyenv を使う python-build を使う( 参考 ) ソースからビルドする 1 の apt だと，3.7 や 3.…]]></description><link>https://note.mjunya.com/posts/2022-02-08-build-python-from-source-in-dockerfile/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2022-02-08-build-python-from-source-in-dockerfile/</guid><pubDate>Tue, 08 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;コンテナ内で自由にバージョンを指定して Python を使いたいときがある．&lt;br/&gt;
方法としては以下が考えられる．&lt;/p&gt;&lt;ol&gt;&lt;li&gt;apt などでインストールする&lt;/li&gt;&lt;li&gt;pyenv を使う&lt;/li&gt;&lt;li&gt;python-build を使う(&lt;a href=&quot;https://qiita.com/shngt/items/51102aeb81834d0d3d7a&quot;&gt;参考&lt;/a&gt;)&lt;/li&gt;&lt;li&gt;ソースからビルドする&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;1 の apt だと，3.7 や 3.9 などの 2 桁目までは指定できるが，
3.9.1 や 3.9.2 までは指定できない．(セキュリティ的にはこっちが良いが)．
そもそも Image によっては欲しいバージョンがない場合もある．&lt;/p&gt;&lt;p&gt;次に 2,3 の pyenv や python-build を使用する方法だが，
pyenv をクローンしてこなければならないので，回りくどい．&lt;br/&gt;
あと，ホストマシンで pyenv local しているディレクトリをマウントして，
コンテナ内でそのディレクトリに入ると，存在しないバージョンを参照されてしまうので，
何かとやりづらい．&lt;/p&gt;&lt;p&gt;やっぱりソースからビルドするのが一番素直で楽なのかもしれない．&lt;/p&gt;&lt;p&gt;というわけで，Dockerfile 例は以下．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; nvidia/cuda:11.2-cudnn8-devel-ubuntu20.04&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ARG&lt;/span&gt; PYTHON=&lt;span class=&quot;token string&quot;&gt;&amp;quot;3.9.10&amp;quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt-get update &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; apt-get install -y --no-install-recommends &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# Python build dependencies&lt;/span&gt;
    make &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    build-essential &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libssl-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    zlib1g-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libbz2-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libreadline-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libsqlite3-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    wget &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    curl &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    llvm &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libncursesw5-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    xz-utils &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    tk-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libxml2-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libxmlsec1-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    libffi-dev &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    liblzma-dev&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; wget -q &lt;span class=&quot;token string&quot;&gt;&amp;quot;https://www.python.org/ftp/python/${PYTHON}/Python-${PYTHON}.tar.xz&amp;quot;&lt;/span&gt; &amp;amp;&amp;amp;&lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    tar xvf Python-&lt;span class=&quot;token variable&quot;&gt;${PYTHON}&lt;/span&gt;.tar.xz &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    cd Python-&lt;span class=&quot;token variable&quot;&gt;${PYTHON}&lt;/span&gt; &amp;amp;&amp;amp;&lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    ./configure --enable-optimizations --without-ensurepip --enable-loadable-sqlite-extensions &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    make -j 8 &amp;amp;&amp;amp;&lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    make install &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    cd ../ &amp;amp;&amp;amp; rm -rf Python-&lt;span class=&quot;token variable&quot;&gt;${PYTHON}&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    python3 -V &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    ln -s /usr/local/bin/python3 /usr/local/bin/python&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; curl -kL https://bootstrap.pypa.io/get-pip.py | python &amp;amp;&amp;amp; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    pip --version &amp;amp;&amp;amp;&lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    rm -rf get-pip.py&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; echo &lt;span class=&quot;token string&quot;&gt;&amp;#x27;export PATH=~/.local/bin:$PATH&amp;#x27;&lt;/span&gt; &amp;gt;&amp;gt; ~/.bashrc&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;python3 に python のエイリアスを貼っているので，python コマンドでそのまま任意の Python を使用できる．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[RobotoMonoに日本語を合成したフォントを作りました]]></title><description><![CDATA[こんにちは．今回は自作したフォントについて紹介します． 普段，ターミナルやエディタのフォントは，GoogleFontで配布されているRobotoMono…]]></description><link>https://note.mjunya.com/posts/2021-12-28-roboto-mono-jp/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-12-28-roboto-mono-jp/</guid><pubDate>Tue, 28 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;こんにちは．今回は自作したフォントについて紹介します．&lt;/p&gt;&lt;p&gt;普段，ターミナルやエディタのフォントは，GoogleFontで配布されているRobotoMonoを使用しているのですが，
このフォントには日本語文字が含まれていません．&lt;br/&gt;
そのため，日本語を入力すると豆腐になってしまったり，OSのデフォルトフォントになってしまったりします．&lt;br/&gt;
そこで，FontForgeを使って日本語フォントを合成して一つのフォントですべてをまかなえるようにしました．&lt;/p&gt;&lt;p&gt;合成したフォントは以下です．&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://fonts.google.com/specimen/Roboto+Mono&quot;&gt;RobotoMono&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/IBM/plex&quot;&gt;IBM plex Sans JP&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/ryanoasis/nerd-fonts&quot;&gt;Nerd Font&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;どれもオープンソースで公開されているので，自由に改変することができます．&lt;br/&gt;
NerdFontは各種アイコンをフォントに埋め込むことができるもので，ターミナルのシェルをPowerlineなどにしている場合は，使っている人も多いと思います．&lt;/p&gt;&lt;p&gt;フォントの見た目は以下のようになっています．&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/05cf46f1e5016ef02888cf9648f1bdfb/b5a09/RobotoMonoJP.png&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:49.5%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABe0lEQVQoz5WSvU7CYBSGex8mDkJbSku1pbRAy09RIrTE0URHRbwAY6KDDoqz4a8Er8Iom5ubi/dgImAEce/wvX7AogNBhifnW97nOyfnMM7tm+/Ue36xOfTdxqfvtpakOalD6uj7RepinNo7tquvKJw9IHfehX36+IfsAuzTLrIn98hfvcCp9cA43ojkyh7J62HCmyphBYXw4f8TkjTCBjli7F2TUntMGLc1glX2oIgKbC0DTUkgJMUgRGIITZA08JTQPCI6WFaAsV9FyRtjKkxV2kibWWzld5DOFpHKuTAzBVj0reoZcGJ0SeGRB02OIhO3YWgWpI0EZNWEuG5MO+WXEw6RPu7ANlLIpQtQaEcR1YJq2BDkOB1Xn4bmIcgJcLxEhTdU+EWF3gjmQR2qJCKZSEEUZQTWgggGOLBBfiEcF0ZgdQX67gXoUuiW631sXj4jediCWenAovyui7mj2SY9uSc49QEYeoxwGwNq/57+MKvLMMu4jQ9MXD8K6Z3Qg5W97QAAAABJRU5ErkJggg==&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;RobotoMonoJP&quot; title=&quot;RobotoMonoJP&quot; src=&quot;/static/05cf46f1e5016ef02888cf9648f1bdfb/5a190/RobotoMonoJP.png&quot; srcSet=&quot;/static/05cf46f1e5016ef02888cf9648f1bdfb/772e8/RobotoMonoJP.png 200w,/static/05cf46f1e5016ef02888cf9648f1bdfb/e17e5/RobotoMonoJP.png 400w,/static/05cf46f1e5016ef02888cf9648f1bdfb/5a190/RobotoMonoJP.png 800w,/static/05cf46f1e5016ef02888cf9648f1bdfb/c1b63/RobotoMonoJP.png 1200w,/static/05cf46f1e5016ef02888cf9648f1bdfb/b5a09/RobotoMonoJP.png 1360w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;ダウンロードは私のGithubリポジトリから行うことができます．&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/mjun0812/RobotoMonoJP&quot;&gt;https://github.com/mjun0812/RobotoMonoJP&lt;/a&gt;&lt;/p&gt;&lt;p&gt;あまりフォントに詳しくないため，不備があるかもしれません．ご了承ください．&lt;br/&gt;
ソースコードも添付しているので，改変する方はそちらを読んでみてください．&lt;br/&gt;
ライセンスもオープンにしています．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[GPUを複数搭載した計算機でGPUの順番を設定する]]></title><description><![CDATA[マルチ GPU を搭載したマシンで， nvidia-smi で見える GPU ID と，
PyTorch や Tensorflow， CUDA_VISIBLE_DEVICES で指定する GPU ID が異なる現象についてのメモ． 結論から言うと， nvidia-smi…]]></description><link>https://note.mjunya.com/posts/2021-12-13-multi-gpu-order/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-12-13-multi-gpu-order/</guid><pubDate>Mon, 13 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;マルチ GPU を搭載したマシンで，&lt;code class=&quot;language-text&quot;&gt;nvidia-smi&lt;/code&gt;で見える GPU ID と，
PyTorch や Tensorflow，&lt;code class=&quot;language-text&quot;&gt;CUDA_VISIBLE_DEVICES&lt;/code&gt;で指定する GPU ID が異なる現象についてのメモ．&lt;/p&gt;&lt;p&gt;結論から言うと，&lt;code class=&quot;language-text&quot;&gt;nvidia-smi&lt;/code&gt;では PCI BUS 順に並ぶが，
CUDA ではデフォルトでは早い順(&lt;code class=&quot;language-text&quot;&gt;FASTEST_FIRST&lt;/code&gt;)に GPU の ID が振られることが原因だった．&lt;/p&gt;&lt;p&gt;A6000 x 2，RTX 3090 x 2 が刺さっているマシンを想定し，
&lt;code class=&quot;language-text&quot;&gt;nvidia-smi&lt;/code&gt;で並ぶ GPU の順番が以下のようだったとする．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;: RTX &lt;span class=&quot;token number&quot;&gt;3090&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;: A6000
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;: A6000
&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;: RTX &lt;span class=&quot;token number&quot;&gt;3090&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;すると，PyTorch 側では以下のように並ぶ．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;: A6000  &lt;span class=&quot;token comment&quot;&gt;# (nvidia-smiでは1)&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;: A6000  &lt;span class=&quot;token comment&quot;&gt;# (nvidia-smiでは2)&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;: RTX &lt;span class=&quot;token number&quot;&gt;3090&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;# (nvidia-smiでは0)&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;: RTX &lt;span class=&quot;token number&quot;&gt;3090&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;# (nvidia-smiでは3)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;PyTorch 側でも&lt;code class=&quot;language-text&quot;&gt;nvidia-smi&lt;/code&gt;(PCI バス順)の順番で
GPU の ID を振りたい時は以下のように環境変数を設定する．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;CUDA_DEVICE_ORDER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;PCI_BUS_ID&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# または，&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;CUDA_DEVICE_ORDER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;PCI_BUS_ID&amp;quot;&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;CUDA_VISIBLE_DEVICE&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt; python train.py&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これで，上記のマシンでは，&lt;code class=&quot;language-text&quot;&gt;nvidia-smi&lt;/code&gt;の順番となり，RTX 3090 が ID=0 となる．&lt;/p&gt;&lt;p&gt;コード上で変更するには，以下のようにする(Python)&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; os

os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;CUDA_DEVICE_ORDER&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;PCI_BUS_ID&amp;quot;&lt;/span&gt;
os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;CUDA_VISIBLE_DEVICES&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;0, 3&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ちなみに，PyTorch では，以下のコードで GPU の情報を表示できる&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torch

&lt;span class=&quot;token comment&quot;&gt;# os.environ[&amp;quot;CUDA_DEVICE_ORDER&amp;quot;] = &amp;quot;PCI_BUS_ID&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# os.environ[&amp;quot;CUDA_VISIBLE_DEVICES&amp;quot;] = &amp;quot;0,1,2,3&amp;quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cuda&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;device_count&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    info &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; torch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cuda&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get_device_properties&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&amp;quot;CUDA:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;info&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;info&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;total_memory &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;MB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;環境変数の設定は，torch.cuda 周りを呼び出す前に行わければならないのに注意．&lt;/p&gt;&lt;p&gt;ここまで書いてきて，常に&lt;code class=&quot;language-text&quot;&gt;PCI_BUS_ID&lt;/code&gt;順にすればいいじゃんと思うかもしれないが，
Multi-GPU で異なる GPU を混ぜて推論するときには，
GPU ID=0 で損失計算などを行うので，GPU ID=0 の GPU の計算が早いほうが嬉しい．
そのため，早い順に GPU が並ぶのも利点が一応ある．&lt;/p&gt;&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#env-vars&quot;&gt;https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#env-vars&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[RTX3000番台(Ampere)でtensorflow-gpu 1.15を使う]]></title><description><![CDATA[こんにちは．今回はRTX3090や3080などのGPUでTensorflowの1.15を利用する方法をメモします． 公式が配布しているTensorflowで3000番台のGPUを利用するには2系に上げなければいけません. Tensorflowは1系と2系でAPI…]]></description><link>https://note.mjunya.com/posts/2021-12-12-tf-1-15-rtx-3000/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-12-12-tf-1-15-rtx-3000/</guid><pubDate>Sun, 12 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;こんにちは．今回はRTX3090や3080などのGPUでTensorflowの1.15を利用する方法をメモします．&lt;/p&gt;&lt;p&gt;公式が配布しているTensorflowで3000番台のGPUを利用するには2系に上げなければいけません.&lt;br/&gt;
Tensorflowは1系と2系でAPIの仕様が変更されているため，1系のコードを動かすのは大変です．&lt;/p&gt;&lt;p&gt;そこで，公式が配布しているものではなく，Nvidiaが配布しているものを使います．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;pip &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; nvidia-pyindex
pip &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; nvidia-tensorflow&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要件として，&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Ubuntu 20.04 or later&lt;/li&gt;&lt;li&gt;Nvidia Driver r455&lt;/li&gt;&lt;li&gt;Python 3.8&lt;/li&gt;&lt;li&gt;pip 19.0 or later&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;が求められます．&lt;/p&gt;&lt;p&gt;これでTensorflow==1.15がRTX 3090でも使えます！&lt;/p&gt;&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://developer.nvidia.com/blog/accelerating-tensorflow-on-a100-gpus/&quot;&gt;https://developer.nvidia.com/blog/accelerating-tensorflow-on-a100-gpus/&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zenn.dev/pinto0309/articles/9e54ee8d15189a&quot;&gt;https://zenn.dev/pinto0309/articles/9e54ee8d15189a&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/NVIDIA/tensorflow&quot;&gt;https://github.com/NVIDIA/tensorflow&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Google Domainsを使ってDDNSを設定]]></title><description><![CDATA[今回は，Google Domains の DDNS を使ってドメインに動的に ip アドレスを振る方法を書く． DDNS とは DDNS は Dynamic DNS の略で，ドメインに割り当てられたホストの IP アドレスに変更があった場合に DNS…]]></description><link>https://note.mjunya.com/posts/2021-12-06-googledomains-ddns/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-12-06-googledomains-ddns/</guid><pubDate>Mon, 06 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は，Google Domains の DDNS を使ってドメインに動的に ip アドレスを振る方法を書く．&lt;/p&gt;&lt;h2 id=&quot;ddns-とは&quot;&gt;DDNS とは&lt;/h2&gt;&lt;p&gt;DDNS は Dynamic DNS の略で，ドメインに割り当てられたホストの IP アドレスに変更があった場合に DNS サーバに通知を行って，ドメインの IP を変更するサービスのことである．&lt;/p&gt;&lt;p&gt;通常の光回線契約では，HGW ルータの電源を入れ直す度に新しいグローバル IP が付与されることが多い．その場合，ドメインに紐づけられた IP を都度変更しなければならない．もちろん固定 IP の契約もできるが料金がかかるため，小規模な自宅サーバなら DDNS を利用したほうが低コストで常時自宅サーバにドメイン名でアクセスできる．&lt;/p&gt;&lt;h2 id=&quot;google-domains&quot;&gt;Google Domains&lt;/h2&gt;&lt;p&gt;Google Domains では DDNS が利用でき，サーバ側で&lt;code class=&quot;language-text&quot;&gt;ddclient&lt;/code&gt;を使えば簡単に DDNS を利用できる．
取得方法は Google のことなので，仕様変更が多々あると思うので，公式を参考に．&lt;/p&gt;&lt;h2 id=&quot;ddclient&quot;&gt;ddclient&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; ddclient&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;インストールの際，GUI で色々聞かれますが，後から設定ファイルで設定するので適当に埋めていく．&lt;/p&gt;&lt;p&gt;設定例は以下．場所は&lt;code class=&quot;language-text&quot;&gt;/etc/ddclient.conf&lt;/code&gt;&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;conf&quot;&gt;&lt;pre class=&quot;language-conf&quot;&gt;&lt;code class=&quot;language-conf&quot;&gt;# /etc/ddclient.conf
daemon=60 # サービス化して定期実行する感覚

ssl=yes
protocol=googledomains
use=web
login=[Google Domainsで取得]
password=[Google Domainsで取得]
hoge.hoge.com # DDNSを設定するドメイン&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Google Domains で取得する場所はここ．&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/4102de885ee3e61bbd0e35e8e1f84e4a/75d3b/ddns.png&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:24%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuklEQVQY041P267DIAzr///pjrZCgZALpV7C2aRpT0OynFjIdjbqHSKC4DEG5nVhzum4XpgfeO3xxzHOCVaHTVSe6DKw1VrRGiHnA9wZwwZMzUMUGvDZzFZYBAd3ZtcVLIZCilQY90Pc/MTGXUGHouyM409QHoyWdHEg3QhUZJm+jeIa9jkCzHcJXRjn6YY5Z6yWtTk3kLfd94SU0tKj0a9vhGGksie9EadGg9oaGtFqFdo/5Is/dVl/nx1/hnvr0syzAAAAAElFTkSuQmCC&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;images&quot; title=&quot;images&quot; src=&quot;/static/4102de885ee3e61bbd0e35e8e1f84e4a/5a190/ddns.png&quot; srcSet=&quot;/static/4102de885ee3e61bbd0e35e8e1f84e4a/772e8/ddns.png 200w,/static/4102de885ee3e61bbd0e35e8e1f84e4a/e17e5/ddns.png 400w,/static/4102de885ee3e61bbd0e35e8e1f84e4a/5a190/ddns.png 800w,/static/4102de885ee3e61bbd0e35e8e1f84e4a/c1b63/ddns.png 1200w,/static/4102de885ee3e61bbd0e35e8e1f84e4a/29007/ddns.png 1600w,/static/4102de885ee3e61bbd0e35e8e1f84e4a/75d3b/ddns.png 1966w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;ここから認証情報を取得して設定する．&lt;/p&gt;&lt;p&gt;さらに，DDNS をサービス化して定期実行する場合は&lt;code class=&quot;language-text&quot;&gt;/etc/default/ddclient&lt;/code&gt;を編集する．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;diff&quot;&gt;&lt;pre class=&quot;language-diff&quot;&gt;&lt;code class=&quot;language-diff&quot;&gt;# /etc/default/ddclient

&lt;span class=&quot;token deleted-sign deleted&quot;&gt;&lt;span class=&quot;token prefix deleted&quot;&gt;-&lt;/span&gt; run_daemon=&amp;quot;false&amp;quot;
&lt;/span&gt;&lt;span class=&quot;token inserted-sign inserted&quot;&gt;&lt;span class=&quot;token prefix inserted&quot;&gt;+&lt;/span&gt; run_daemon=&amp;quot;true&amp;quot;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これであとはサービスに登録すれば OK．&lt;/p&gt;&lt;p&gt;手動実行する場合は以下を実行する．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; ddclient -daemon&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; -verbose&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://qiita.com/gorohash/items/8287738ffe47ab52a36f&quot;&gt;https://qiita.com/gorohash/items/8287738ffe47ab52a36f&lt;/a&gt;
&lt;a href=&quot;https://www.uchidigi.com/2020/01/ddclient-google-ddns.html&quot;&gt;https://www.uchidigi.com/2020/01/ddclient-google-ddns.html&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[unboundで内向きDNSを作る(Ubuntu20.04)]]></title><description><![CDATA[本ページでは，自宅ネットワーク内にDNSサーバを立ち上げる方法についてメモを書く． 今回はunboundを使って構築する． 自宅DNSサーバを立てる理由 自宅に内向きDNSサーバを立てるメリットは以下があげられる． プロバイダーの提供するDNS…]]></description><link>https://note.mjunya.com/posts/2021-12-05-unbound-dns-ubuntu/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-12-05-unbound-dns-ubuntu/</guid><pubDate>Sun, 05 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本ページでは，自宅ネットワーク内にDNSサーバを立ち上げる方法についてメモを書く．&lt;br/&gt;
今回はunboundを使って構築する．&lt;/p&gt;&lt;h2 id=&quot;自宅dnsサーバを立てる理由&quot;&gt;自宅DNSサーバを立てる理由&lt;/h2&gt;&lt;p&gt;自宅に内向きDNSサーバを立てるメリットは以下があげられる．&lt;/p&gt;&lt;ol&gt;&lt;li&gt;プロバイダーの提供するDNSサーバに影響を受けない&lt;/li&gt;&lt;li&gt;ドメインを付与した外部公開しているサーバがある場合，自宅ネットワーク内からでもドメインで名前解決できる．&lt;/li&gt;&lt;li&gt;好きな名前で自宅内のホストに名前解決できる&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;1について，大抵はプロバイダーのDNSを使っていると考えられる．
このDNSを変更したい場合は自分で立てるメリットがある．
デバイスごとに変更することもできるが，ネットワーク内の全デバイスに対して適用したい場合は，大本のDNS参照先を変えてしまったほうが早い．&lt;/p&gt;&lt;p&gt;2について，自宅のグローバルIPにドメインを振っている場合，外部からドメイン名で名前解決して自宅内サーバにアクセスすることはできる．(というかそのためにドメイン振ってる)&lt;br/&gt;
しかし，アクセスしたいサーバと同じネットワークにいる場合，ドメイン名でアクセスができない．(これをうまく解決してくれるルーターもあるらしい．)
これを解決する方法は，デバイスのhostsファイルに書き込むなどの方法があるが，新しいデバイスが来るたびにこれをやっているときりがないので，自分でDNSサーバを立てると楽できる．&lt;/p&gt;&lt;p&gt;3についてはおまけで，sshならconfigで好きな名前にできるし，&lt;code class=&quot;language-text&quot;&gt;.local&lt;/code&gt;がついてしまうが，avahiを利用してmDNSを使うこともできる．&lt;/p&gt;&lt;p&gt;まとめると，自宅DNSサーバを立てるは，「一括で」ネットワーク内の名前解決を設定できるという点が大きい．&lt;/p&gt;&lt;h2 id=&quot;技術選定&quot;&gt;技術選定&lt;/h2&gt;&lt;p&gt;DNSサーバを立てる方法はいくつかあって，一番有名なのはbindだと思う．&lt;br/&gt;
脆弱性が多いというデメリットが散見されるが，自宅内だけで利用し，外部に公開しないのであればそこまで気にしなくても大丈夫だと考えられる．&lt;/p&gt;&lt;p&gt;しかし，自宅内だけで使うには機能が過剰で，設定ファイルも冗長なので，今回は設定ファイルが簡素なunboundを選定した．&lt;/p&gt;&lt;h2 id=&quot;install&quot;&gt;install&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; unbound&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;設定ファイル例は以下．&lt;/p&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/etc/unbound/unbound.conf.d/&lt;/code&gt;に設定ファイルを置く．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;chroot&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;verbosity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 127.0.0.0
  &lt;span class=&quot;token key atrule&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;

  &lt;span class=&quot;token key atrule&quot;&gt;do-ip4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes
  &lt;span class=&quot;token key atrule&quot;&gt;do-ip6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes

  &lt;span class=&quot;token comment&quot;&gt;# アクセス制限 ローカルのみ許可&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0.0.0.0/0 refuse
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1/0 refuse
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 127.0.0.1/32 allow
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 192.168.0.0/24 allow
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;1/128 allow
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; fd00&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/8 allow
  &lt;span class=&quot;token key atrule&quot;&gt;access-control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; fe80&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/64 allow

  &lt;span class=&quot;token key atrule&quot;&gt;prefetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes
  &lt;span class=&quot;token key atrule&quot;&gt;hide-identity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes
  &lt;span class=&quot;token key atrule&quot;&gt;hide-version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes

  &lt;span class=&quot;token comment&quot;&gt;# 逆引き&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;local-data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;hoge.com. IN A 1.1.1.1&amp;quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Google DNS&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;forward-zone&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;forward-addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 8.8.8.8
  &lt;span class=&quot;token key atrule&quot;&gt;forward-addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 8.8.4.4
  &lt;span class=&quot;token key atrule&quot;&gt;forward-addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 2001&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;4860&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;4860&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8888&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;forward-addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 2001&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;4860&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;4860&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8844&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;local-data:&lt;/code&gt;のところが逆引き設定．
forward-zoneはGoogleのDNSを設定している．
あとはルータでDNSサーバが参照されるようにすればOK．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Pythonでforを並列化する]]></title><description><![CDATA[Pythonで複数ファイルに対して同じ操作をしたいときに，1つずつ開いて操作をしていると遅いので，
並列化して高速化することを目論む． 本ページでは雛形を提示する． 並行処理と並列処理 英語では以下のように表現する． 並行処理: Concurrency…]]></description><link>https://note.mjunya.com/posts/2021-11-14-python-parallels/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-11-14-python-parallels/</guid><pubDate>Sun, 14 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Pythonで複数ファイルに対して同じ操作をしたいときに，1つずつ開いて操作をしていると遅いので，
並列化して高速化することを目論む．&lt;br/&gt;
本ページでは雛形を提示する．&lt;/p&gt;&lt;h2 id=&quot;並行処理と並列処理&quot;&gt;並行処理と並列処理&lt;/h2&gt;&lt;p&gt;英語では以下のように表現する．&lt;/p&gt;&lt;ul&gt;&lt;li&gt;並行処理: Concurrency&lt;/li&gt;&lt;li&gt;並列処理: Parallel&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;細かい話は他の文献に譲るとして，簡単に説明すると&lt;/p&gt;&lt;ul&gt;&lt;li&gt;並行処理は，ある時間の範囲内で複数の処理を行うこと．&lt;/li&gt;&lt;li&gt;並列処理は，ある時間の範囲内で同時に処理を行うこと．&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;並行処理は同じ時間に1つの仕事しかしないが，各処理をちょっとずつ進めたり，一方の処理の待ち時間でCPUが空いてるときに他方の処理をするなどして高速化する．効率的に処理を切り替えることで高速化する．&lt;/p&gt;&lt;p&gt;並列処理は同じ時間に複数の作業を同時に行うことで高速化する．&lt;/p&gt;&lt;p&gt;並行処理は無駄をなくす，並列処理は道路を増やすという方法で高速化する．&lt;/p&gt;&lt;p&gt;図で示すと以下のようなイメージ．&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:800px&quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/9441e7e16f28482da867e84445477d97/d9199/2021-11-14-python-parallels_image1.png&quot; style=&quot;display:block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:56.49999999999999%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVQoz2VQXW+jMBDk//+XvkWRLjkSVenTSZHumpZUyQUSCGAC2ATwBwbbt5hTlaqj0bKeZe3Zddq3t851xdOTCEMD0BoC7YaPS7Y/o5r3o2ZsxX5T3O6OUZg3XHQOqao0y1A+QttO6Bddj4oqK2tKKcmiFqPpUkDDZHIrSSvGZsYYSBlCu93O87yDBcblMIxv9rzJAq9GftXmaXEtGqT0MN0ipXQYpZCxtiWEYIzv9zvnXMqecd4Pg1LjgxCOqbd5Xf0+/+IdH2WlbTPnn1NNAPO9lFoNRiuIGixo9VBWxpa6Dmz7vtlu9fOzKgr4RQ0KunnXJ4Sllqjil4wcowyUhFBQEkwRoWNz6fvRZoNeXowdflqMkP2tovl9ZFGz+IaDGEEyKTdYQNV2YJvCiEoJ/Wjc6I4ZEpnqOrKOGTqVwfv/I5CEmlzlaNsuzMAGgBZw4oIm5TnFFyAiYYhOwfUAyaTEZQBVIYQD1s03UNn8LbxTsQf65cc+/vN63kIyKcf8PSgP/dA7s9lssVj8+IrlYun+XH1y5a7X7vpRcZer+Xz+D0h8Yhd3l/yxAAAAAElFTkSuQmCC&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;並行・並列処理&quot; title=&quot;並行・並列処理&quot; src=&quot;/static/9441e7e16f28482da867e84445477d97/5a190/2021-11-14-python-parallels_image1.png&quot; srcSet=&quot;/static/9441e7e16f28482da867e84445477d97/772e8/2021-11-14-python-parallels_image1.png 200w,/static/9441e7e16f28482da867e84445477d97/e17e5/2021-11-14-python-parallels_image1.png 400w,/static/9441e7e16f28482da867e84445477d97/5a190/2021-11-14-python-parallels_image1.png 800w,/static/9441e7e16f28482da867e84445477d97/d9199/2021-11-14-python-parallels_image1.png 960w&quot; sizes=&quot;(max-width: 800px) 100vw, 800px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;(&lt;a href=&quot;https://blog.framinal.life/entry/2020/04/05/204055&quot;&gt;https://blog.framinal.life/entry/2020/04/05/204055&lt;/a&gt;)より引用&lt;/p&gt;&lt;/blockquote&gt;&lt;h2 id=&quot;スレッドとプロセス&quot;&gt;スレッドとプロセス&lt;/h2&gt;&lt;p&gt;プロセスはプログラム1つの実行単位．&lt;br/&gt;
スレッドはプロセスの中の実行単位．&lt;br/&gt;
プロセスの中に複数のスレッドが存在する．&lt;/p&gt;&lt;p&gt;スレッドはプロセス内の同じメモリ空間を共有できる．&lt;br/&gt;
プロセスではプロセスごとにメモリ空間が確保されるため，データを共有するにはプロセス間通信を行う必要がある．&lt;/p&gt;&lt;p&gt;CPUコアの実行単位はスレッドなので，スレッドによってCPUのコアを変更することができる．&lt;br/&gt;
しかし，PythonではGILがあるので，スレッドごとにCPUコアを切り替えることは出来ない．&lt;br/&gt;
よって複数コアを使用するにはマルチプロセスで実装する．&lt;/p&gt;&lt;h2 id=&quot;pythonでの実装&quot;&gt;Pythonでの実装&lt;/h2&gt;&lt;p&gt;Pythonで並列・並行処理を実装するには以下の方法(標準ライブラリ)がある．&lt;/p&gt;&lt;ul&gt;&lt;li&gt;並行処理&lt;ul&gt;&lt;li&gt;threading&lt;/li&gt;&lt;li&gt;concurrent.futures&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;並列処理&lt;ul&gt;&lt;li&gt;multiprocessing&lt;/li&gt;&lt;li&gt;concurrent.futures&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;concurrent.futures&lt;/code&gt;はPython3.2から追加された，threadingやmultiprocessingのラッパー．&lt;br/&gt;
コードが簡単になるのでとりあえずこれを使う．&lt;/p&gt;&lt;p&gt;前述の通り，PythonのGILによってスレッド周りでの高速化はあまり期待できないので，並列処理でマルチプロセスしたほうが早くなる場合が多い．&lt;/p&gt;&lt;h2 id=&quot;並列処理のコード例&quot;&gt;並列処理のコード例&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; concurrent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;futures &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; ProcessPoolExecutor
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; tqdm &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; tqdm

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;idx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# -------------------(1)&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# for文の1つ単位の処理を関数化する&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; _fn&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; d&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# tqdmで経過が知りたい時&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; tqdm&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;total&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; progress&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; ProcessPoolExecutor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;max_workers&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;worker_num&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; executor&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# -----(2)&lt;/span&gt;
            result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 処理結果を保存するlist&lt;/span&gt;

            &lt;span class=&quot;token comment&quot;&gt;# 1. 引数にiterできないオブジェクトがある時&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; d &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;enumerate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;# -------(3)&lt;/span&gt;
                future &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; executor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;submit&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; d&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                result&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;future&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token comment&quot;&gt;# tqdmで経過が知りたい時&lt;/span&gt;
                future&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add_done_callback&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;lambda&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; progress&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;update&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; ProcessPoolExecutor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;max_workers&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;worker_num&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; executor&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# -----(2)&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# 2. 引数がiterできる場合&lt;/span&gt;
        result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tqdm&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;executor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; total&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;



&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;tqdmで経過を確認できるようにした．&lt;/p&gt;&lt;ol&gt;&lt;li&gt;並列化したい処理を関数に書き出す((1)のfn関数)&lt;/li&gt;&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;with ProcessPoolExecutor(max_workers=worker_num) as executor:&lt;/code&gt;内でexecutorに関数とその引数を&lt;code class=&quot;language-text&quot;&gt;submit or map&lt;/code&gt;で渡す．&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;2について，関数の引数がiter可能な場合はmapを使えば(3)のforを省略できる．&lt;/p&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://qiita.com/tag1216/items/db5adcf1ddcb67cfefc8&quot;&gt;https://qiita.com/tag1216/items/db5adcf1ddcb67cfefc8&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Pandasで標準出力したDataframeにgrepする]]></title><description><![CDATA[Pythonのデータ分析のライブラリにPandasというライブラリがある． 個人的には2次元配列をきれいに標準出力できるのでよく使っていたりする(完全に邪道)． Pandasは print(df…]]></description><link>https://note.mjunya.com/posts/2021-10-20-pandas-output-grep/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-10-20-pandas-output-grep/</guid><pubDate>Wed, 20 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Pythonのデータ分析のライブラリにPandasというライブラリがある．&lt;br/&gt;
個人的には2次元配列をきれいに標準出力できるのでよく使っていたりする(完全に邪道)．&lt;br/&gt;
Pandasは&lt;code class=&quot;language-text&quot;&gt;print(df)&lt;/code&gt;したときに，ご丁寧に端末の横幅を考慮して省略して出力してくれるのだが，それだと
&lt;code class=&quot;language-text&quot;&gt;python pands.py | grep ABC&lt;/code&gt;したときに省略部分に検索語句があると検索漏れしてしまう．&lt;br/&gt;
そこで，データの行の横幅を無視するオプションを設定することでgrepで指定行を検索できるようにする．  &lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; pd

pd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;set_option&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;display.width&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;display.width&lt;/code&gt;の初期値は80である．&lt;br/&gt;
Noneにすることで制限を解除する．&lt;br/&gt;
これでPandasの出力にgrepをかけることが可能になった．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[git pushで複数の場所にpushする]]></title><description><![CDATA[いつも忘れてしまうのでメモ。 自宅サーバでGitLabを動かしてたり、サーバー内にもリモートリポジトリを置きたい等の理由から、
Github以外にもリモートリポジトリを持ちたいという場合は多い。 その際、いちいちpush先を選択してそれぞれpush…]]></description><link>https://note.mjunya.com/posts/2021-10-19-git-push-multi-remote/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-10-19-git-push-multi-remote/</guid><pubDate>Tue, 19 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;いつも忘れてしまうのでメモ。&lt;br/&gt;
自宅サーバでGitLabを動かしてたり、サーバー内にもリモートリポジトリを置きたい等の理由から、
Github以外にもリモートリポジトリを持ちたいという場合は多い。&lt;br/&gt;
その際、いちいちpush先を選択してそれぞれpushしていくのは手間なので、
一度のgit pushで複数のリモートリポジトリにpushできるようにする。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# まずはpush, fetch先の登録&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; remote &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; origin git@github.com:hoge/hoge.git
&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; remote set-url --add origin git@gitlab.com:fuga/fuga.git

&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; remote -v

origin  git@github.com:hoge/hoge.git &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fetch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
origin  git@github.com:hoge/hoge.git &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;push&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
origin  git@gitlab.com:huga/huga.git &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;push&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これでgit pushすれば1回で複数のリモートリポジトリにpushできる。&lt;/p&gt;&lt;p&gt;リスク分散は大事。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[PyTorchで画像を読み込む速度を比較]]></title><description><![CDATA[こんにちは．今回はPyTorchで画像を読み込んでTensorに変換するまでの速度を，様々なライブラリで比較してみました． 使用するライブラリ opencv-python: 4.5.3.56 Pillow(PIL): 8.3.2 Pillow-SIMD: 7.0.0.post…]]></description><link>https://note.mjunya.com/posts/2021-10-10-PyTorch-Image-Load-Speed/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-10-10-PyTorch-Image-Load-Speed/</guid><pubDate>Sun, 10 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;こんにちは．今回はPyTorchで画像を読み込んでTensorに変換するまでの速度を，様々なライブラリで比較してみました．&lt;/p&gt;&lt;h2 id=&quot;使用するライブラリ&quot;&gt;使用するライブラリ&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;opencv-python: 4.5.3.56&lt;/li&gt;&lt;li&gt;Pillow(PIL): 8.3.2&lt;/li&gt;&lt;li&gt;Pillow-SIMD: 7.0.0.post3&lt;/li&gt;&lt;li&gt;torchvision.io(PIL): 0.10.1&lt;/li&gt;&lt;li&gt;torchvision.io(accimage): 0.10.1&lt;/li&gt;&lt;li&gt;scikit-image: 0.18.3&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;それぞれのインストール方法は省略する．  &lt;/p&gt;&lt;p&gt;Pillow-SIMDはPillowの高速版であるが，最近は更新されておらず，7.0.0で更新が止まっている．&lt;br/&gt;
&lt;a href=&quot;https://github.com/pytorch/accimage&quot;&gt;accimage&lt;/a&gt;はtorchvisionのバックエンドに指定できるライブラリで，condaでインストールできる．&lt;/p&gt;&lt;h2 id=&quot;実験&quot;&gt;実験&lt;/h2&gt;&lt;p&gt;ソースコードは以下&lt;br/&gt;
&lt;a href=&quot;https://buildersbox.corp-sansan.com/entry/2020/11/05/110000&quot;&gt;こちら&lt;/a&gt;を参考にした，&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; time
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; contextlib &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; contextmanager

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cv2
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; PIL &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Image
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; skimage&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torchvision
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; torchvision&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;transforms&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;functional &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; TF
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; torchvision&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; read_image


&lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@contextmanager&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;timer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&amp;quot;[&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;] done in &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token format-spec&quot;&gt;.03f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; ms&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;


N_ITERS &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; FILENAME &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;./image.jpg&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;./image.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; timer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;PIL&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N_ITERS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Image&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;convert&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;RGB&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; TF&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_tensor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;img&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; timer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;OpenCV&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N_ITERS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;imread&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;copy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; TF&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_tensor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;img&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; timer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;default_torchvision&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N_ITERS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; read_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; timer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;accimage_torchvision&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        torchvision&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;set_image_backend&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;accimage&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N_ITERS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; read_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; timer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;quot;skimage&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;N_ITERS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; skimage&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;imread&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILENAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; TF&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_tensor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;img&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;一応Githubにもソースを公開する．&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/mjun0812/Pytorch-Image-Load-Speed&quot;&gt;https://github.com/mjun0812/Pytorch-Image-Load-Speed&lt;/a&gt;&lt;/p&gt;&lt;p&gt;画像はよく使われるマンドリルの画像を用いている．&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th align=&quot;center&quot;&gt;画像形式&lt;/th&gt;&lt;th&gt;ライブラリ&lt;/th&gt;&lt;th align=&quot;right&quot;&gt;速度(ms)&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;jpg&lt;/td&gt;&lt;td&gt;opencv-python&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;673.799&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;772.203&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow-SIMD&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;648.018&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;301.993&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;278.904&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(accimage)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;274.502&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;794.349&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;545.362&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;png&lt;/td&gt;&lt;td&gt;opencv-python&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1066.164&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1752.472&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow-SIMD&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1085.250&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;877.775&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;867.422&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io(accimage)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;847.297&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1878.370&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1108.291&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;最も早いのは&lt;code class=&quot;language-text&quot;&gt;torchvision.io.read_image&lt;/code&gt;となった．&lt;br/&gt;
Pillow-SIMDでの高速化は,scikit-imageにも影響を与えている．内部的に使われているのであろう．&lt;br/&gt;
ただ，torchvisionにはPillow-SIMDの効果は見られなかった．&lt;/p&gt;&lt;p&gt;この際，画像のロード速度もついでに比較．&lt;br/&gt;
Tensorに変更しないこともあると思うので．&lt;br/&gt;
Tensorが出力として出てくる&lt;code class=&quot;language-text&quot;&gt;torchvision.io.read_image&lt;/code&gt;は，&lt;code class=&quot;language-text&quot;&gt;numpy()&lt;/code&gt;でndarrayに変換するまでを計測する．&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th align=&quot;center&quot;&gt;画像形式&lt;/th&gt;&lt;th&gt;ライブラリ&lt;/th&gt;&lt;th align=&quot;right&quot;&gt;速度(ms)&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;jpg&lt;/td&gt;&lt;td&gt;opencv-python&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;457.877&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;772.203&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow-SIMD&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;648.018&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;273.161&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;794.349&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;545.362&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;png&lt;/td&gt;&lt;td&gt;opencv-python&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;962.926&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow(PIL)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1752.472&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;Pillow-SIMD&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1085.250&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;torchvision.io&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;795.085&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1878.370&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td&gt;scikit-image(PIL-SIMD)&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;1108.291&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;なんとこちらも&lt;code class=&quot;language-text&quot;&gt;torchvision.io&lt;/code&gt;が一番早い結果となった．  &lt;/p&gt;&lt;h2 id=&quot;注意&quot;&gt;注意&lt;/h2&gt;&lt;p&gt;Pillow-SIMDは古いPillowをベースとしているため，以下の警告が出る．&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;txt&quot;&gt;&lt;pre class=&quot;language-txt&quot;&gt;&lt;code class=&quot;language-txt&quot;&gt;UserWarning: Your installed pillow version is &amp;lt; 7.1.0. Several security issues (CVE-2020-11538, CVE-2020-10379, CVE-2020-10994, CVE-2020-10177) have been fixed in pillow 7.1.0 or higher. We recommend to upgrade this library.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;セキュリティ上のリスクが有るようなので，使わない方が無難だろう．&lt;/p&gt;</content:encoded></item><item><title><![CDATA[SSHのOption, Configまわりの設定]]></title><description><![CDATA[まずは基本系 デフォルトではポート22に接続される。usernameは省略できる。省略した場合は現在のPCのusernameで接続される。 ~/.ssh/config Unix, Linuxではuserのホームディレクトリの .ssh/ 以下に秘密鍵やconfig…]]></description><link>https://note.mjunya.com/posts/2021-07-04-ssh-config/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-07-04-ssh-config/</guid><pubDate>Sun, 04 Jul 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h2 id=&quot;まずは基本系&quot;&gt;まずは基本系&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; username@&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;hostname or ip&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;デフォルトではポート22に接続される。usernameは省略できる。省略した場合は現在のPCのusernameで接続される。&lt;/p&gt;&lt;h2 id=&quot;sshconfig&quot;&gt;~/.ssh/config&lt;/h2&gt;&lt;p&gt;Unix, Linuxではuserのホームディレクトリの&lt;code class=&quot;language-text&quot;&gt;.ssh/&lt;/code&gt;以下に秘密鍵やconfigを保存する。
.sshディレクトリは700、.ssh以下のファイルには600の権限を付与する。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token output&quot;&gt;~/.ssh/
├── authorized_keys
├── config
├── id_rsa
├── id_rsa.pub
├── known_hosts
├── known_hosts-e&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ssh接続を楽にするためにconfigファイルに予め接続設定を書いておく。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token output&quot;&gt;Host hoge
  HostName 192.168.0.0
  User hoge
  Port 22
  IdentifyFile ~/.ssh/id_rsa&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記の設定を&lt;code class=&quot;language-text&quot;&gt;~/.ssh/config&lt;/code&gt;に書いておくと&lt;code class=&quot;language-text&quot;&gt;ssh hoge&lt;/code&gt;のみで接続することが可能になる。&lt;/p&gt;&lt;h2 id=&quot;多段ssh&quot;&gt;多段ssh&lt;/h2&gt;&lt;p&gt;セキュリティ上の理由で。接続したい端末に直接接続出来ない場合がある。
例えば、接続したい端末へローカルネットワークでしか接続できず、プロキシーサーバ(接続したい端末と同じネットワーク内にあり、外からアクセスできる。)を介して接続する場合が考えられる。
この場合、Client -&amp;gt; Proxy -&amp;gt; Targetというようにssh接続を重ねて接続しなければならない。これをsshコマンド1行またはssh configで行う方法について説明する。&lt;/p&gt;&lt;p&gt;まずはsshコマンド&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; -o &lt;span class=&quot;token assign-left variable&quot;&gt;ProxyCommand&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;ssh -W %h:%p Proxy&amp;#x27;&lt;/span&gt; Target&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-o&lt;/code&gt;はssh の設定を指定できるオプションで、ssh configよりも優先される。&lt;/p&gt;&lt;p&gt;続いてssh configでの設定。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell-session&quot;&gt;&lt;pre class=&quot;language-shell-session&quot;&gt;&lt;code class=&quot;language-shell-session&quot;&gt;&lt;span class=&quot;token output&quot;&gt;Host proxy
    User hoge

Host target
    User fuga
    ProxyCommand  ssh -W %h:%p proxy&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記の設定をした上で&lt;code class=&quot;language-text&quot;&gt;ssh target&lt;/code&gt;をすれば踏み台の先のサーバに接続できる。&lt;/p&gt;&lt;h2 id=&quot;sshコマンドのオプションとssh-configの対応&quot;&gt;sshコマンドのオプションとssh configの対応&lt;/h2&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;command&lt;/th&gt;&lt;th&gt;config&lt;/th&gt;&lt;th&gt;説明&lt;/th&gt;&lt;th&gt;例&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;-p&lt;/td&gt;&lt;td&gt;Port&lt;/td&gt;&lt;td&gt;接続先のPortの指定&lt;/td&gt;&lt;td&gt;ssh -p 22&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-i&lt;/td&gt;&lt;td&gt;IdentifyFile&lt;/td&gt;&lt;td&gt;接続に使用する秘密鍵のPath&lt;/td&gt;&lt;td&gt;ssh -i ~/.ssh/hoge_rsa&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-X&lt;/td&gt;&lt;td&gt;ForwardX11&lt;/td&gt;&lt;td&gt;Xwindowを転送するかどうか。&lt;/td&gt;&lt;td&gt;ForwardX11 yes&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-Y&lt;/td&gt;&lt;td&gt;ForwardX11Trusted&lt;/td&gt;&lt;td&gt;信頼されたXwindowの転送。macOSでXquartzを使うときはこれ。&lt;/td&gt;&lt;td&gt;ForwardX11Trusted yes&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-L&lt;/td&gt;&lt;td&gt;LocalForward&lt;/td&gt;&lt;td&gt;クライアントのポートをリモートのネットワーク内のPCに飛ばす&lt;/td&gt;&lt;td&gt;ssh -L 8080:remote_pc:80&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-o StrictHostKeyChecking=&lt;/td&gt;&lt;td&gt;StrictHostKeyChecking&lt;/td&gt;&lt;td&gt;known_hostの扱いを決める。&lt;/td&gt;&lt;td&gt;yes(接続しない)、no(接続する)、ask(default 確認させる)&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h3 id=&quot;macosに使える設定&quot;&gt;macOSに使える設定&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;AddKeysToAgent&lt;/li&gt;&lt;li&gt;UseKeychain&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ssh agentに鍵を登録する。再起動時にも有効。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Shell Scriptでオプション解析をする getopts]]></title><description><![CDATA[こんにちは。今回もShellScript絡みです。 本稿ではShell Scriptでオプション引数を扱うgetoptについてメモします。 Pythonだとargparseですね。 getoptとgetopts Shell Scriptでオプション引数を扱うにはgetopt…]]></description><link>https://note.mjunya.com/posts/2021-06-02-getopt-in-shellscript/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-06-02-getopt-in-shellscript/</guid><pubDate>Wed, 02 Jun 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;こんにちは。今回もShellScript絡みです。&lt;br/&gt;
本稿ではShell Scriptでオプション引数を扱うgetoptについてメモします。&lt;br/&gt;
Pythonだとargparseですね。&lt;/p&gt;&lt;h2 id=&quot;getoptとgetopts&quot;&gt;getoptとgetopts&lt;/h2&gt;&lt;p&gt;Shell Scriptでオプション引数を扱うにはgetoptとgetoptsの2つの方法がある。&lt;br/&gt;
getoptは外部コマンドでgetoptsはbash組み込みのコマンドです。&lt;br/&gt;
getoptはBSD(macOS)とGNU(Linux)で挙動が異なるため、汎用性を考えたときにはgetoptsを使ったほうが良い。[&lt;a href=&quot;https://takuya-1st.hatenablog.jp/entry/2015/12/24/234238&quot;&gt;1&lt;/a&gt;]&lt;/p&gt;&lt;h2 id=&quot;usage&quot;&gt;Usage&lt;/h2&gt;&lt;p&gt;というわけで本稿ではgetoptsに絞ってオプション引数の扱い方を見ていきます。&lt;br/&gt;
早速ですが使い方は以下のようになります。[&lt;a href=&quot;https://www.atmarkit.co.jp/ait/articles/2002/13/news025.html&quot;&gt;2&lt;/a&gt;]&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;getopts&lt;/span&gt; abc OPT
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$OPT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
     a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;use -a option&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
     b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;use -b option&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
     c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;use -c option&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;esac&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記のスクリプトの実行結果は以下です。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./a.sh

./a.sh -a
&lt;span class=&quot;token comment&quot;&gt;# use -a option&lt;/span&gt;

./a.sh -b
&lt;span class=&quot;token comment&quot;&gt;# use -b option&lt;/span&gt;

./a.sh -d
&lt;span class=&quot;token comment&quot;&gt;#./a.sh: illegal option -- d&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上記のスクリプトですが、エラーメッセージを表示させない場合は&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;- &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;getopts&lt;/span&gt; abc OPT

+ &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;getopts&lt;/span&gt; :abc OPT&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;に変更すればErrorメッセージが表示されません。&lt;/p&gt;&lt;p&gt;オプションに追加して引数を受け入れる場合は以下のように、オプション文字の後に&lt;code class=&quot;language-text&quot;&gt;:&lt;/code&gt;を追加します。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;getopts&lt;/span&gt; a: OPT
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$OPT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
     a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;use -a option and input &lt;span class=&quot;token variable&quot;&gt;$OPTARG&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;esac&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;これを実行すると、&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./a.sh -a aaa
&lt;span class=&quot;token comment&quot;&gt;# use -a option and input aaa&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;となります。&lt;/p&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;h3 id=&quot;文献&quot;&gt;文献&lt;/h3&gt;&lt;p&gt;[1]: &lt;a href=&quot;https://takuya-1st.hatenablog.jp/entry/2015/12/24/234238&quot;&gt;https://takuya-1st.hatenablog.jp/entry/2015/12/24/234238&lt;/a&gt;  &lt;/p&gt;&lt;p&gt;[2]: &lt;a href=&quot;https://www.atmarkit.co.jp/ait/articles/2002/13/news025.html&quot;&gt;https://www.atmarkit.co.jp/ait/articles/2002/13/news025.html&lt;/a&gt;  &lt;/p&gt;</content:encoded></item><item><title><![CDATA[Shell Scriptで使う条件分岐 test]]></title><description><![CDATA[本稿ではShell Scriptで条件分岐に用いられる、testコマンドについて書く。
どのような条件分岐が可能であるかを、testコマンドのオプションをベースに列挙する。
シェルスクリプトでの利用を想定しているため、 [ ] での記述を行う。 条件 内容 -a file…]]></description><link>https://note.mjunya.com/posts/2021-05-24-test-in-shellscript/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-05-24-test-in-shellscript/</guid><pubDate>Mon, 24 May 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本稿ではShell Scriptで条件分岐に用いられる、testコマンドについて書く。
どのような条件分岐が可能であるかを、testコマンドのオプションをベースに列挙する。
シェルスクリプトでの利用を想定しているため、&lt;code class=&quot;language-text&quot;&gt;[ ]&lt;/code&gt;での記述を行う。&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;条件&lt;/th&gt;&lt;th&gt;内容&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;-a file&lt;/td&gt;&lt;td&gt;ファイルが存在すればtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-d file&lt;/td&gt;&lt;td&gt;ファイルがディレクトリならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-e file&lt;/td&gt;&lt;td&gt;ファイルが存在すればtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-f file&lt;/td&gt;&lt;td&gt;ファイルが通常ファイルならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-h file&lt;/td&gt;&lt;td&gt;ファイルがシンボリックリンクならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-r file&lt;/td&gt;&lt;td&gt;ファイルが読み込み可能ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-s file&lt;/td&gt;&lt;td&gt;ファイルサイズが0より大きければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-w file&lt;/td&gt;&lt;td&gt;ファイルが書き込み可能ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-x file&lt;/td&gt;&lt;td&gt;ファイルが実行可能ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -nt b&lt;/td&gt;&lt;td&gt;aがbより更新日時が新しければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -ot b&lt;/td&gt;&lt;td&gt;aがbより更新日時が古ければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-z str&lt;/td&gt;&lt;td&gt;strが空文字ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;-n str&lt;/td&gt;&lt;td&gt;strが空文字でないならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;str1 = str2&lt;/td&gt;&lt;td&gt;str1,str2が同じならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;str1 == str2&lt;/td&gt;&lt;td&gt;str1,str2が同じならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;str1 != str2&lt;/td&gt;&lt;td&gt;str1,str2が異なるならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;str1 &amp;lt; str2&lt;/td&gt;&lt;td&gt;str1がstr2よりも辞書順で前ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;str1 &amp;gt; str2&lt;/td&gt;&lt;td&gt;str1がstr2よりも辞書順で後ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -eq b&lt;/td&gt;&lt;td&gt;a,bの数字が等しければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -ne b&lt;/td&gt;&lt;td&gt;a,bの数字が等しくなければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -lt b&lt;/td&gt;&lt;td&gt;aがb以下ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -le b&lt;/td&gt;&lt;td&gt;aがb未満ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -gt b&lt;/td&gt;&lt;td&gt;aがbより大きければtrue&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;a -ge b&lt;/td&gt;&lt;td&gt;aがb以上ならtrue&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;h3 id=&quot;書籍&quot;&gt;書籍&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://amzn.to/3vkzkgM&quot;&gt;[改訂第3版]シェルスクリプト基本リファレンス ──#!/bin/shで、ここまでできる (WEB+DB PRESS plus)&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Shell Script]]></title><description><![CDATA[本稿ではshellscriptについて基本的なことを書く。 Shell Scriptの1行目 この一行目はシバン(shebang) [ 1 ] という。 #![インタプリタのパス] [インタプリタの引数] で指定する。 if文の書き方 then, fi…]]></description><link>https://note.mjunya.com/posts/2021-05-24-shell-script/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-05-24-shell-script/</guid><pubDate>Mon, 24 May 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本稿ではshellscriptについて基本的なことを書く。&lt;/p&gt;&lt;h2 id=&quot;shell-scriptの1行目&quot;&gt;Shell Scriptの1行目&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/sh&lt;/span&gt;

pythonは
&lt;span class=&quot;token comment&quot;&gt;#!/usr/bin/env python&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;この一行目はシバン(shebang) [&lt;a href=&quot;https://qiita.com/nafuka/items/c97bfd2a4ca26e70e722&quot;&gt;1&lt;/a&gt;] という。&lt;code class=&quot;language-text&quot;&gt;#![インタプリタのパス] [インタプリタの引数]&lt;/code&gt;で指定する。&lt;/p&gt;&lt;h2 id=&quot;if文の書き方&quot;&gt;if文の書き方&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;fileが存在します&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;fileが存在します&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;ファイルが存在します&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;then, fiの前には終端記号のコロン(;)か改行が必要。&lt;/p&gt;&lt;h2 id=&quot;パイプ---リスト--&quot;&gt;パイプ( | ), リスト( ; )&lt;/h2&gt;&lt;p&gt;パイプラインは複数のコマンドをパイプ(|)でつなげたもの。コマンドの標準出力を別のコマンドの標準出力に接続させる。
リストは1つ以上のパイプラインを、改行・;・&amp;amp;・&amp;amp;&amp;amp;・||で区切って並べたもの。
&amp;amp;の前はバックグラウンドで動作する。&lt;/p&gt;&lt;h2 id=&quot;-と-&quot;&gt;&amp;amp;&amp;amp; と ||&lt;/h2&gt;&lt;p&gt;&amp;amp;&amp;amp;はAND処理、||はOR処理であるが、Shellscript(C言語)のシステム上、左から順にコマンドが実行される。&lt;br/&gt;
&amp;amp;&amp;amp;の場合は左のコマンドが偽であった場合は右のコマンドは実行されない。&lt;br/&gt;
||の場合は左のコマンドが真であった場合は右のコマンドが実行されない。&lt;br/&gt;
この挙動を利用して、簡単な条件分岐が行える。
&amp;amp;&amp;amp;では左のコマンドが真のときのみ右のコマンドを行う。||では左のコマンドが偽のときに右のコマンドを行う。
といったように使用できる。&lt;/p&gt;&lt;h2 id=&quot;if文&quot;&gt;if文&lt;/h2&gt;&lt;p&gt;基本形は以下の通り。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;i=3&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;i=4&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;i!=3,4&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;testコマンド（上記だと[ ]で書かれている）を用いない場合は以下の通り&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; -s file1 file2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# -sオプションでメッセージなし&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;file1==file2&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;file1!=file2&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;#または&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; -s file1 file2
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$?&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;file1==file2&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;2つ目の書き方は、if文の記法をtest([])に揃えるためのもの。&lt;code class=&quot;language-text&quot;&gt;$?&lt;/code&gt;で実行ステータスを確認できるため、それを利用している。&lt;/p&gt;&lt;p&gt;否定条件も使える。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt; -eq &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
 &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;i!=3&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ifと[の間にはスペースが必要。&lt;/p&gt;&lt;h2 id=&quot;case文&quot;&gt;case文&lt;/h2&gt;&lt;p&gt;基本形は以下の通り。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uname&lt;/span&gt; -s&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  Linux&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;FreeBSD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;this OS is Linux or FreeBSD&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  *&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;other OS&amp;#x27;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;esac&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;if文で毎回コマンド実行するよりはこっちのほうが簡潔に書けたりする。&lt;/p&gt;&lt;h2 id=&quot;for文&quot;&gt;for文&lt;/h2&gt;&lt;p&gt;基本形は以下の通り。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; memo.txt prog.txt fig1.png
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; 
  &lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; -p &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$file&lt;/span&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$file&lt;/span&gt;&amp;quot;&lt;/span&gt;.bak
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;

memo.txt.bak
prog.txt.bak
fig1.png.bak&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;for file in *&lt;/code&gt;のようにすると、カレントディレクトリの全てのファイルが引数fileに代入される。
&lt;code class=&quot;language-text&quot;&gt;for file in `&amp;lt; filelist`&lt;/code&gt;のようにするとファイルから入力を行える。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;txt&quot;&gt;&lt;pre class=&quot;language-txt&quot;&gt;&lt;code class=&quot;language-txt&quot;&gt;# filelist
memo.txt
prog.txt
fig1.png&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;他の言語と同じように&lt;code class=&quot;language-text&quot;&gt;continue, break&lt;/code&gt;が使える。&lt;/p&gt;&lt;p&gt;算術式を用いる場合は以下の通り。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;((&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;))&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;((&lt;/span&gt;sum &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;))&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;while文&quot;&gt;while文&lt;/h2&gt;&lt;p&gt;基本の文は以下の通り。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt; -le &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$sum&lt;/span&gt;&amp;quot;&lt;/span&gt; + &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token assign-left variable&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;&amp;quot;&lt;/span&gt; + &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;bashの場合は&lt;code class=&quot;language-text&quot;&gt;`expr &amp;quot;$i&amp;quot; + 1`&lt;/code&gt;の代わりに&lt;code class=&quot;language-text&quot;&gt;((i++))&lt;/code&gt;が使える。&lt;/p&gt;&lt;p&gt;無限ループにする場合は&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;のようにセミコロン(:)を用いる。&lt;/p&gt;&lt;h2 id=&quot;select文&quot;&gt;select文&lt;/h2&gt;&lt;p&gt;選択メニューを表示して、応答を受け付ける事ができる。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;PS3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;コマンド?&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;cmd&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; up down left right quit
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
    up&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;up&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    down&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;down&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    left&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;left&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    right&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;right&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    quit&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    *&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$REPLAY&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;は選択不可&amp;#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;esac&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;selectの要素に連番をつけたメニューとPS3を出力する。
上のコードの結果は以下のようになる。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;txt&quot;&gt;&lt;pre class=&quot;language-txt&quot;&gt;&lt;code class=&quot;language-txt&quot;&gt;1) up      2) down    3) left    4) right   5) quit
コマンド?1
up
コマンド?2
down
コマンド?5&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;サブシェルとグループコマンド&quot;&gt;サブシェルとグループコマンド&lt;/h2&gt;&lt;p&gt;サブシェルでは別のシェルで、グループコマンドは現在のシェルで一連のコマンドを行う。
使用例は以下。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# サブシェル&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; /hoge/etc
  &lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; -p aaa &lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;/
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;gt;&lt;/span&gt; log

&lt;span class=&quot;token comment&quot;&gt;#グループコマンド&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;uname&lt;/span&gt; -a
  &lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;who&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;gt;&lt;/span&gt; log&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;関数&quot;&gt;関数&lt;/h2&gt;&lt;p&gt;基本文は以下。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function-name function&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;Hello World!&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

func&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;関数内で引数を用いるには、呼び出し時に以下のようにする。[&lt;a href=&quot;https://qiita.com/kaw/items/034bc4221c4526fe8866&quot;&gt;3&lt;/a&gt;]&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function-name function&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

func &lt;span class=&quot;token string&quot;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;配列&quot;&gt;配列&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;three&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# three&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;array2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;one two three&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${array2&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# one two three&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;unset&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;array2[1]&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${array2&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;@&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# one three&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;関数の最初の{の後にはスペースか改行が必要。
&lt;code class=&quot;language-text&quot;&gt;func(){ echo Hello;}&lt;/code&gt;&lt;/p&gt;&lt;h2 id=&quot;算術式の評価と条件式の評価&quot;&gt;算術式の評価(())と条件式の評価[[]]&lt;/h2&gt;&lt;p&gt;bashにて実装された機能。&lt;br/&gt;
算術式の評価では中にC言語Likeな算術を書ける。
条件式の評価では&lt;code class=&quot;language-text&quot;&gt;&amp;lt;&amp;gt;,(),&amp;amp;&amp;amp;,||&lt;/code&gt;をクォートする必要がない。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;((&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;))&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a -a b &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a -o b &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;testコマンドとの違い[&lt;a href=&quot;https://qiita.com/kiyodori/items/e9fabcba03fc1e76dbdd&quot;&gt;2&lt;/a&gt;]&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;条件式&lt;/th&gt;&lt;th&gt;test&lt;/th&gt;&lt;th&gt;[[]]&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;AND&lt;/td&gt;&lt;td&gt;a -a b&lt;/td&gt;&lt;td&gt;a &amp;amp;&amp;amp; b&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;OR&lt;/td&gt;&lt;td&gt;a -o b&lt;/td&gt;&lt;td&gt;a&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;文字列比較&lt;/td&gt;&lt;td&gt;文字列a == 文字列b&lt;/td&gt;&lt;td&gt;文字列a == パターンb&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h2 id=&quot;シェル変数の代入と参照&quot;&gt;シェル変数の代入と参照&lt;/h2&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;hello world&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$a&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${a}&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;シングルクォートとダブルクォートの使い分けに気をつける。シングルなら展開無しでそのまま代入される。&lt;/p&gt;&lt;h2 id=&quot;位置パラメータ&quot;&gt;位置パラメータ&lt;/h2&gt;&lt;p&gt;シェルスクリプトのの引数を参照できる。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ./aaa.sh a b c d
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# a&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;$0&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# ./aaa.sh&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${10}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Oct&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;特殊パラメータ&quot;&gt;特殊パラメータ&lt;/h2&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;パラメータ&lt;/th&gt;&lt;th&gt;内容&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;$0&lt;/td&gt;&lt;td&gt;起動されたシェルスクリプト名&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$1~9&lt;/td&gt;&lt;td&gt;それぞれの引数(arg1~9)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$@&lt;/td&gt;&lt;td&gt;引数全てのリスト&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$*&lt;/td&gt;&lt;td&gt;引数全てを連結して参照する&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$#&lt;/td&gt;&lt;td&gt;引数の数を表示する($0は含まれない)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$?&lt;/td&gt;&lt;td&gt;終了コードを参照する&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$!&lt;/td&gt;&lt;td&gt;最後にバックグラウンドで実行したプロセスID&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;\$$&lt;/td&gt;&lt;td&gt;シェル自身のプロセスID&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$-&lt;/td&gt;&lt;td&gt;現在のシェルのオプションフラグ&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;$_&lt;/td&gt;&lt;td&gt;直前に実行したコマンドの最後の引数&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h2 id=&quot;パラメータ展開&quot;&gt;パラメータ展開&lt;/h2&gt;&lt;h3 id=&quot;パラメータのデフォルト値&quot;&gt;パラメータのデフォルト値&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${1&lt;span class=&quot;token operator&quot;&gt;:-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;tmp}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${1-&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;tmp}&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;上の例の場合は引数1が設定されていないか、空文字のときに&lt;code class=&quot;language-text&quot;&gt;/tmp&lt;/code&gt;が展開され、下の場合には設定されてない場合のみ&lt;code class=&quot;language-text&quot;&gt;/tmp&lt;/code&gt;が展開される。
空文字を無視するかしないかで判断する。&lt;/p&gt;&lt;h3 id=&quot;パラメータへデフォルト値を代入&quot;&gt;パラメータへデフォルト値を代入&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${DIST&lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;tmp}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${DIST=&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;tmp}&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;前述のものと違い、代入してから展開する。&lt;/p&gt;&lt;h3 id=&quot;パラメータ未設定時にエラーを出力&quot;&gt;パラメータ未設定時にエラーを出力&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${1&lt;span class=&quot;token operator&quot;&gt;:?&lt;/span&gt;error&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt; ./
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${1?error&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt; ./&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;パラメータが設定されていなければ、?の後に記述したメッセージが表示されてスクリプトが終了する。&lt;/p&gt;&lt;h3 id=&quot;パラメータの長さ&quot;&gt;パラメータの長さ&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;${&lt;span class=&quot;token operator&quot;&gt;#&lt;/span&gt;test}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;パラメータの文字列の長さを返す。&lt;br/&gt;
スクリプトで使わなくても、コマンド&lt;code class=&quot;language-text&quot;&gt;cat text | wc -c&lt;/code&gt;でも代用できる。&lt;/p&gt;&lt;h3 id=&quot;パラメータからパターンを削除&quot;&gt;パラメータからパターンを削除&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${DIR&lt;span class=&quot;token operator&quot;&gt;#&lt;/span&gt;*&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${DIR&lt;span class=&quot;token operator&quot;&gt;##&lt;/span&gt;*&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;}&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;${パラメータ#パターン}&lt;/code&gt;のように使う。#が1つだと最短の部分が、#が2つだと最長の部分が左から取り除かれる。&lt;/p&gt;&lt;p&gt;#を%に変更すると右側から取り除かれる。&lt;/p&gt;&lt;h3 id=&quot;文字列の一部を抜粋&quot;&gt;文字列の一部を抜粋&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;${パラメータ&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;オフセット&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;長さ}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;オフセットで戦闘から何文字削除するか、長さで削除した文字列のうち先頭の何文字を表示するか決定する。&lt;/p&gt;&lt;h3 id=&quot;パラメータの置換&quot;&gt;パラメータの置換&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;${パラメータ&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;パターン&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;置換文字列}&lt;/span&gt;
&lt;span class=&quot;token variable&quot;&gt;${パラメータ&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;パターン&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;置換文字列}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt;が1つだと先頭の1つを置換する。2つだと全て置換する。&lt;/p&gt;&lt;h2 id=&quot;文字列の囲み方&quot;&gt;文字列の囲み方&lt;/h2&gt;&lt;p&gt;シングルクォート&lt;code class=&quot;language-text&quot;&gt;&amp;#x27; &amp;#x27;&lt;/code&gt;では文字列がそのまま表示される。ダブルクオート&lt;code class=&quot;language-text&quot;&gt;&amp;quot; &amp;quot;&lt;/code&gt;ではパラメータ展開とコマンド置換が行われる。
バッククォート&lt;code class=&quot;language-text&quot;&gt;` `&lt;/code&gt;では囲んだ部分でのコマンドの標準入力で置換が行われる。&lt;code class=&quot;language-text&quot;&gt;$( )&lt;/code&gt;はバッククォートと同じことを書き方を変えて行える。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&amp;#x27;hello&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;${a}&amp;#x27;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# ${a}&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;${a}&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# hello&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# /home/user&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;quot;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# /home/user&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;リダイレクト&quot;&gt;リダイレクト&lt;/h2&gt;&lt;h3 id=&quot;入力&quot;&gt;入力&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;出力&quot;&gt;出力&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;Hello World&amp;#x27;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;gt;&lt;/span&gt; log&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;追記&quot;&gt;追記&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; log&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;エラー出力&quot;&gt;エラー出力&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; -rf non-exist &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&amp;gt;&lt;/span&gt; /dev/null &lt;span class=&quot;token comment&quot;&gt;# エラーメッセージを出さずに削除&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;ヒアドキュメント&quot;&gt;ヒアドキュメント&lt;/h3&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;EOF&amp;#x27;
abcde
abcde
EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;終了文字列(上記だとEOF)がシングルクォートされてると変数展開等は行われない。&lt;/p&gt;&lt;h3 id=&quot;ヒアストリング&quot;&gt;ヒアストリング&lt;/h3&gt;&lt;p&gt;基本的にはヒアストリングと一緒。終了文字列を書かなくて良い。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;abcde
abcde&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;よく使うコマンド&quot;&gt;よく使うコマンド&lt;/h2&gt;&lt;h3 id=&quot;expr&quot;&gt;expr&lt;/h3&gt;&lt;p&gt;数値計算を行う。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;expr&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; + &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 8&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;basename&quot;&gt;basename&lt;/h3&gt;&lt;p&gt;ファイル名のみを出力する。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;basename&lt;/span&gt; /home/user/test.txt
&lt;span class=&quot;token comment&quot;&gt;# test.txt&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;basename&lt;/span&gt; /home/user/test.txt .txt
&lt;span class=&quot;token comment&quot;&gt;# test&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;dirname&quot;&gt;dirname&lt;/h3&gt;&lt;p&gt;ディレクトリ名を表示する。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;dirname&lt;/span&gt; /home/user/test.txt
&lt;span class=&quot;token comment&quot;&gt;# /home/user&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;dirname&lt;/span&gt; test.txt
&lt;span class=&quot;token comment&quot;&gt;# .&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;wc&quot;&gt;wc&lt;/h3&gt;&lt;p&gt;ファイルの行数、文字数、サイズを表示できる。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;wc&lt;/span&gt; -lwc test.txt
&lt;span class=&quot;token comment&quot;&gt;# row&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# words&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# size&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&quot;sed&quot;&gt;sed&lt;/h3&gt;&lt;p&gt;ファイルの中の文字列を置き換える。&lt;/p&gt;&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;aaaaccccaaaa&amp;#x27;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;gt;&lt;/span&gt; old.txt

&lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;s/aaaa/b/&amp;#x27;&lt;/span&gt; old.txt
&lt;span class=&quot;token comment&quot;&gt;# bccccaaaa&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;#x27;s/aaaa/b/g&amp;#x27;&lt;/span&gt; old.txt
&lt;span class=&quot;token comment&quot;&gt;# bccccb&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;&lt;h3 id=&quot;文献&quot;&gt;文献&lt;/h3&gt;&lt;p&gt;[1]: &lt;a href=&quot;https://qiita.com/nafuka/items/c97bfd2a4ca26e70e722&quot;&gt;https://qiita.com/nafuka/items/c97bfd2a4ca26e70e722&lt;/a&gt;  &lt;/p&gt;&lt;p&gt;[2]: &lt;a href=&quot;https://qiita.com/kiyodori/items/e9fabcba03fc1e76dbdd&quot;&gt;https://qiita.com/kiyodori/items/e9fabcba03fc1e76dbdd&lt;/a&gt;&lt;/p&gt;&lt;p&gt;[3]: &lt;a href=&quot;https://qiita.com/kaw/items/034bc4221c4526fe8866&quot;&gt;https://qiita.com/kaw/items/034bc4221c4526fe8866&lt;/a&gt;&lt;/p&gt;&lt;h3 id=&quot;書籍&quot;&gt;書籍&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://amzn.to/3vkzkgM&quot;&gt;[改訂第3版]シェルスクリプト基本リファレンス ──#!/bin/shで、ここまでできる (WEB+DB PRESS plus)&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[First Post]]></title><description><![CDATA[ブログ、はじめました こんにちは。はじめまして。
本サイトは、僕のノートとして情報系に関して学んだことを書いていきたいと思います。 よろしくお願いします。 サイトを構成する技術 本サイトはReact製の静的サイトジェネレーターであるGatsby.js…]]></description><link>https://note.mjunya.com/posts/2021-05-18-first-post/</link><guid isPermaLink="false">https://note.mjunya.com/posts/2021-05-18-first-post/</guid><pubDate>Tue, 18 May 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h2 id=&quot;ブログはじめました&quot;&gt;ブログ、はじめました&lt;/h2&gt;&lt;p&gt;こんにちは。はじめまして。
本サイトは、僕のノートとして情報系に関して学んだことを書いていきたいと思います。&lt;br/&gt;
よろしくお願いします。&lt;/p&gt;&lt;h2 id=&quot;サイトを構成する技術&quot;&gt;サイトを構成する技術&lt;/h2&gt;&lt;p&gt;本サイトはReact製の静的サイトジェネレーターであるGatsby.jsを用いてサイト構築を行っています。&lt;br/&gt;
生成した静的ファイルはGithub Pagesで管理しています。&lt;/p&gt;&lt;h2 id=&quot;注意&quot;&gt;注意&lt;/h2&gt;&lt;p&gt;本サイトには誤りや、浅い知識が含まれる場合があります。
可能な限り正しい知識を掲載しようと考えていますが、ご容赦願います。&lt;/p&gt;</content:encoded></item></channel></rss>